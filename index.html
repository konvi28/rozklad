<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/webp" href="logo.webp">
    <link rel="shortcut icon" type="image/webp" href="logo.webp">
    <link rel="apple-touch-icon" href="logo.webp">
    <title>–†–æ–∑–∫–ª–∞–¥ —É—Ä–æ–∫—ñ–≤ v 3.6.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .container {
            max-width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9em;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0;
        }

        .tab {
            flex: 1;
            padding: 12px 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 14px;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 0 20px 20px 20px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .tab-content > h2:first-child,
        .tab-content > .save-load-section:first-child {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-hour-control {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .btn-hour-control:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .btn-hour-control:active {
            transform: scale(0.95);
        }

        .btn-success {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            font-size: 13px;
            margin-right: 5px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            padding: 8px 15px;
            font-size: 13px;
        }

        .btn-info:hover {
            background: #138496;
        }

        .save-load-section {
            margin-bottom: 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 0;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            scroll-margin: 0;
        }

        .save-load-section * {
            scroll-margin: 0;
        }

        #scheduleContent {
            padding-top: 10px;
        }

        .save-load-section h3 {
            width: 100%;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        #excelInput {
            display: none;
        }

        .class-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .class-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        .class-card h3 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .class-card-actions {
            margin-top: 15px;
        }

        .subject-list {
            margin-top: 30px;
        }

        .subject-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .subject-info {
            flex: 1;
        }

        .subject-name {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }

        .subject-teacher {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        .subject-hours {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-right: 10px;
        }

        .tiles-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            min-height: 50px;
        }

        .tiles-container.drag-over {
            background: #e7f3ff;
            border: 2px dashed #667eea;
        }

        .lesson-tile {
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: move;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .lesson-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .lesson-tile.dragging {
            opacity: 0.5;
        }

        .lesson-tile.used {
            background: #6c757d !important;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .schedule-wrapper {
            overflow: auto;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1;
            min-height: 0;
        }
        
        .schedule-wrapper::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .schedule-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .schedule-wrapper::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .schedule-wrapper::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            background: white;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #000000;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
        }
        
        .schedule-table th:first-child {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }
        
        .schedule-table th:first-child,
        .schedule-table th:nth-child(2) {
            position: sticky;
            left: 0;
            z-index: 11;
        }
        
        .schedule-table th:nth-child(2) {
            left: auto;
        }

        .schedule-table td {
            padding: 5px;
            border: 1px solid #000000;
            text-align: center;
            vertical-align: middle;
            min-height: 60px;
        }
        
        .schedule-table td:first-child {
            position: sticky;
            left: 0;
            background: #e9ecef;
            z-index: 5;
            font-weight: 600;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }
        
        /* –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è */
        .day-0 { background: #e3f2fd !important; } /* –ü–æ–Ω–µ–¥—ñ–ª–æ–∫ - —Å–≤—ñ—Ç–ª–æ-—Å–∏–Ω—ñ–π */
        .day-1 { background: #f3e5f5 !important; } /* –í—ñ–≤—Ç–æ—Ä–æ–∫ - —Å–≤—ñ—Ç–ª–æ-—Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π */
        .day-2 { background: #e8f5e9 !important; } /* –°–µ—Ä–µ–¥–∞ - —Å–≤—ñ—Ç–ª–æ-–∑–µ–ª–µ–Ω–∏–π */
        .day-3 { background: #fff3e0 !important; } /* –ß–µ—Ç–≤–µ—Ä - —Å–≤—ñ—Ç–ª–æ-–ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π */
        .day-4 { background: #fce4ec !important; } /* –ü'—è—Ç–Ω–∏—Ü—è - —Å–≤—ñ—Ç–ª–æ-—Ä–æ–∂–µ–≤–∏–π */
        
        .schedule-table td.lesson-number {
            position: sticky;
            left: 0;
            z-index: 5;
            writing-mode: horizontal-tb;
            text-orientation: initial;
            padding: 5px;
            width: auto;
            min-width: auto;
            max-width: none;
        }

        .lesson-number {
            font-weight: 600;
            background: #f8f9fa;
            color: #667eea;
        }

        .lesson-slot {
            min-height: 60px;
            background: #f8f9fa;
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            font-size: 12px;
            transition: all 0.3s;
        }

        .lesson-slot:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .lesson-slot.drag-over {
            background: #e7f3ff;
            border-color: #667eea;
            border-style: solid;
        }

        .lesson-card {
            padding: 6px 8px;
            border-radius: 8px;
            color: white;
            cursor: move;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            user-select: none;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .lesson-card.drag-over {
            box-shadow: 0 0 0 3px #667eea;
        }

        .multiple-lessons.drag-over {
            box-shadow: 0 0 0 3px #667eea;
        }

        .schedule-table td.drag-over {
            background: #e7f3ff !important;
        }

        .lesson-card.dragging {
            opacity: 0.5;
        }

        .lesson-card-subject {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .lesson-card-teacher {
            font-size: 10px;
            opacity: 0.9;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .delete-lesson-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 255, 255, 0.9);
            color: #dc3545;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .delete-lesson-btn:hover {
            background: #dc3545;
            color: white;
            opacity: 1;
            transform: scale(1.1);
        }

        .lesson-card:hover .delete-lesson-btn {
            opacity: 1;
        }

        .multiple-lessons {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .lesson-card-split {
            padding: 6px 8px;
            font-size: 12px;
        }

        .lesson-card-split .lesson-card-subject {
            font-size: 12px;
            margin-bottom: 2px;
        }

        .lesson-card-split .lesson-card-teacher {
            font-size: 10px;
        }

        .lesson-card-split .delete-lesson-btn {
            width: 18px;
            height: 18px;
            font-size: 14px;
        }

        .available-tiles-section {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 0;
            max-height: 300px;
            overflow-y: auto;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 80px;
            z-index: 15;
            scroll-margin: 0;
        }
        
        .available-tiles-section * {
            scroll-margin: 0;
        }
        
        .available-tiles-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .available-tiles-section::-webkit-scrollbar-track {
            background: #e9ecef;
            border-radius: 10px;
        }
        
        .available-tiles-section::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .available-tiles-section::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .available-tiles-section h2 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .available-tiles-section .subject-item {
            margin-bottom: 6px;
            padding: 6px;
        }
        
        .available-tiles-section .subject-name {
            font-size: 13px;
        }
        
        .available-tiles-section .subject-teacher {
            font-size: 11px;
        }
        
        .available-tiles-section .tiles-container {
            padding: 5px;
            min-height: 35px;
        }

        .schedules-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .class-schedule-section {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .class-schedule-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #495057;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –∑–≤—ñ—Ç—ñ–≤ */
        .report-result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .report-result h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .teacher-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .teacher-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .teacher-schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .teacher-schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #667eea;
        }

        .teacher-schedule-table td {
            padding: 10px;
            border: 1px solid #e9ecef;
            text-align: center;
            vertical-align: middle;
        }

        .teacher-schedule-table td.has-lesson {
            background: #e7f3ff;
            font-weight: 600;
            color: #333;
        }

        .teacher-schedule-table td.no-lesson {
            background: #f8f9fa;
            color: #adb5bd;
            font-style: italic;
        }

        .teacher-schedule-table .class-name {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        .workload-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .workload-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #667eea;
        }

        .workload-table td {
            padding: 12px;
            border: 1px solid #e9ecef;
        }

        .workload-table tr:hover {
            background: #f8f9fa;
        }

        .workload-bar {
            height: 20px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .workload-light {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        }

        .workload-medium {
            background: linear-gradient(90deg, #fee140 0%, #fa709a 100%);
        }

        .workload-high {
            background: linear-gradient(90deg, #fa709a 0%, #f093fb 100%);
        }

        .footer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ª—É–ø–∏ */
        #magnifier {
            position: fixed;
            width: 200px;
            height: 200px;
            border: 3px solid #667eea;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        #magnifier.active {
            display: block !important;
        }

        .magnifier-active {
            cursor: none !important;
        }

        .magnifier-active * {
            cursor: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö –†–æ–∑–∫–ª–∞–¥ —É—Ä–æ–∫—ñ–≤</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥–æ–º</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('classes')">–ö–ª–∞—Å–∏</button>
            <button class="tab" onclick="switchTab('subjects')">–ü—Ä–µ–¥–º–µ—Ç–∏ —ñ –≤—á–∏—Ç–µ–ª—ñ</button>
            <button class="tab" onclick="switchTab('schedule')">–†–æ–∑–∫–ª–∞–¥</button>
            <button class="tab" onclick="switchTab('reports')">–ó–≤—ñ—Ç–∏</button>
        </div>

        <div id="classesTab" class="tab-content active">
            <h2>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –∫–ª–∞—Å</h2>
            <div class="form-group">
                <label for="className">–ù–∞–∑–≤–∞ –∫–ª–∞—Å—É:</label>
                <input type="text" id="className" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 5-–ê">
            </div>
            <button class="btn btn-primary" onclick="addClass()">–î–æ–¥–∞—Ç–∏ –∫–ª–∞—Å</button>
            
            <h2 style="margin-top: 40px;">–°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—ñ–≤</h2>
            <div id="classList" class="class-list"></div>
        </div>

        <div id="subjectsTab" class="tab-content">
            <h2>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ø—Ä–µ–¥–º–µ—Ç</h2>
            <div class="form-group">
                <label for="subjectName">–ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É:</label>
                <input type="text" id="subjectName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">
            </div>
            <div class="form-group">
                <label for="teacherName">–Ü–º'—è –≤—á–∏—Ç–µ–ª—è:</label>
                <input type="text" id="teacherName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.">
            </div>
            <div class="form-group">
                <label for="hoursPerWeek">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å:</label>
                <input type="number" id="hoursPerWeek" min="1" max="20" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 5">
            </div>
            <button class="btn btn-primary" onclick="addSubject()">–î–æ–¥–∞—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç</button>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="exportSubjectsToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –≤ Excel</button>
                <button class="btn btn-info" onclick="document.getElementById('subjectsExcelInput').click()">üì• –Ü–º–ø–æ—Ä—Ç –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –∑ Excel</button>
                <button class="btn btn-info" onclick="downloadSubjectsTemplate()">üìÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω</button>
                <input type="file" id="subjectsExcelInput" accept=".xlsx,.xls" onchange="importSubjectsFromExcel(event)" style="display: none;">
            </div>
            
            <div id="subjectsStats" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div>
                        <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ñ–≤:</strong> <span id="totalSubjects">0</span>
                    </div>
                    <div>
                        <strong>–£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤:</strong> <span id="totalTeachers">0</span>
                    </div>
                    <div>
                        <strong>–°—É–º–∞—Ä–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω:</strong> <span id="totalHours">0</span>
                    </div>
                </div>
            </div>
            
            <div id="subjectList" class="subject-list"></div>
        </div>

        <div id="scheduleTab" class="tab-content">
            <div class="save-load-section">
                <h3>üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
                <button class="btn btn-info" onclick="downloadScheduleTemplate()">üìÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                <button class="btn btn-info" onclick="document.getElementById('excelInput').click()">üì• –Ü–º–ø–æ—Ä—Ç –∑ Excel</button>
                <button class="btn btn-danger" onclick="clearDemoData()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –¥–∞–Ω—ñ</button>
                <button class="btn btn-info" onclick="checkTeacherConflicts()">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑–±—ñ–≥</button>
                <button class="btn btn-info" onclick="toggleMagnifier()">üîé –õ—É–ø–∞</button>
                <input type="file" id="excelInput" accept=".xlsx,.xls" onchange="importFromExcel(event)">
            </div>
            <div id="scheduleContent"></div>
            
            <!-- –õ—É–ø–∞ -->
            <div id="magnifier" style="display: none;"></div>
        </div>

        <div id="reportsTab" class="tab-content">
            <h2>üìä –ó–≤—ñ—Ç–∏ —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</h2>
            
            <!-- –ó–≤—ñ—Ç 1: –í—ñ–ª—å–Ω—ñ –≤—á–∏—Ç–µ–ª—ñ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px; color: #333;">üïê –í—ñ–ª—å–Ω—ñ –≤—á–∏—Ç–µ–ª—ñ –≤ –æ–±—Ä–∞–Ω–∏–π —á–∞—Å</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å —Ç–∏–∂–Ω—è —Ç–∞ –Ω–æ–º–µ—Ä —É—Ä–æ–∫—É, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —è–∫—ñ –≤—á–∏—Ç–µ–ª—ñ –≤—ñ–ª—å–Ω—ñ (–º–∞—é—Ç—å –≤—ñ–∫–Ω–æ)</p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                        <label for="reportDay">–î–µ–Ω—å —Ç–∏–∂–Ω—è:</label>
                        <select id="reportDay" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                            <option value="">-- –û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å --</option>
                            <option value="0">–ü–æ–Ω–µ–¥—ñ–ª–æ–∫</option>
                            <option value="1">–í—ñ–≤—Ç–æ—Ä–æ–∫</option>
                            <option value="2">–°–µ—Ä–µ–¥–∞</option>
                            <option value="3">–ß–µ—Ç–≤–µ—Ä</option>
                            <option value="4">–ü'—è—Ç–Ω–∏—Ü—è</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                        <label for="reportLesson">–ù–æ–º–µ—Ä —É—Ä–æ–∫—É:</label>
                        <select id="reportLesson" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                            <option value="">-- –û–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫ --</option>
                            <option value="0">1 —É—Ä–æ–∫</option>
                            <option value="1">2 —É—Ä–æ–∫</option>
                            <option value="2">3 —É—Ä–æ–∫</option>
                            <option value="3">4 —É—Ä–æ–∫</option>
                            <option value="4">5 —É—Ä–æ–∫</option>
                            <option value="5">6 —É—Ä–æ–∫</option>
                            <option value="6">7 —É—Ä–æ–∫</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="showFreeTeachers()">üîç –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤</button>
                
                <div id="freeTeachersResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- –ó–≤—ñ—Ç 2: –†–æ–∑–∫–ª–∞–¥ –≤—á–∏—Ç–µ–ª—è -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px; color: #333;">üë®‚Äçüè´ –†–æ–∑–∫–ª–∞–¥ –≤—á–∏—Ç–µ–ª—è</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">–û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –π–æ–≥–æ –ø–æ–≤–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å</p>
                
                <div class="form-group" style="max-width: 400px;">
                    <label for="reportTeacher">–í—á–∏—Ç–µ–ª—å:</label>
                    <select id="reportTeacher" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è --</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="showTeacherSchedule()">üìÖ –ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</button>
                
                <div id="teacherScheduleResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- –ó–≤—ñ—Ç 3: –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—á–∏—Ç–µ–ª—ñ–≤ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <h3 style="margin-bottom: 15px; color: #333;">üìä –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—á–∏—Ç–µ–ª—ñ–≤</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω —É –∫–æ–∂–Ω–æ–≥–æ –≤—á–∏—Ç–µ–ª—è –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å</p>
                
                <button class="btn btn-primary" onclick="showTeachersWorkload()">üìà –ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</button>
                
                <div id="teachersWorkloadResult" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div class="footer">
            –†–æ–∑—Ä–æ–±–Ω–∏–∫ Obariv by Krasovskiy
        </div>
    </div>

    <script>
        const days = ['–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', '–ü\'—è—Ç–Ω–∏—Ü—è'];
        const lessons = 7;
        
        let classes = [
            { id: 1, name: '5-–ê' },
            { id: 2, name: '6-–ë' },
            { id: 3, name: '7-–í' }
        ];
        
        let subjects = [
            { id: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.', hours: 5 },
            { id: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.', hours: 4 },
            { id: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.', hours: 3 },
            { id: 4, name: '–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏', teacher: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –í.–°.', hours: 2 },
            { id: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.', hours: 3 },
            { id: 6, name: '–ë—ñ–æ–ª–æ–≥—ñ—è', teacher: '–ú–µ–ª—å–Ω–∏–∫ –¢.–ê.', hours: 2 },
            { id: 7, name: '–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è', teacher: '–ë–æ–π–∫–æ –ù.–í.', hours: 2 },
            { id: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.', hours: 3 }
        ];
        
        let schedules = {
            1: {
                '0-0': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '0-1': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' },
                '0-2': { subjectId: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.' },
                '1-0': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '1-1': { subjectId: 4, name: '–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏', teacher: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –í.–°.' },
                '1-2': { subjectId: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.' },
                '2-0': { subjectId: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.' },
                '2-1': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '2-2': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' }
            },
            2: {
                '0-0': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' },
                '0-1': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '0-2': { subjectId: 6, name: '–ë—ñ–æ–ª–æ–≥—ñ—è', teacher: '–ú–µ–ª—å–Ω–∏–∫ –¢.–ê.' },
                '1-0': { subjectId: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.' },
                '1-1': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '1-2': { subjectId: 7, name: '–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è', teacher: '–ë–æ–π–∫–æ –ù.–í.' },
                '2-0': { subjectId: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.' },
                '2-1': { subjectId: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.' },
                '2-2': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' }
            },
            3: {
                '0-0': { subjectId: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.' },
                '0-1': { subjectId: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.' },
                '0-2': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '1-0': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' },
                '1-1': { subjectId: 6, name: '–ë—ñ–æ–ª–æ–≥—ñ—è', teacher: '–ú–µ–ª—å–Ω–∏–∫ –¢.–ê.' },
                '1-2': { subjectId: 4, name: '–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏', teacher: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –í.–°.' },
                '2-0': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '2-1': { subjectId: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.' },
                '2-2': { subjectId: 7, name: '–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è', teacher: '–ë–æ–π–∫–æ –ù.–í.' }
            }
        };
        
        let nextClassId = 4;
        let nextSubjectId = 9;

        const subjectColors = [
            '#667eea', '#f093fb', '#4facfe', '#43e97b',
            '#fa709a', '#fee140', '#30cfd0', '#a8edea',
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'
        ];

        function getSubjectColor(subjectId) {
            return subjectColors[(subjectId - 1) % subjectColors.length];
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function addClass() {
            const name = document.getElementById('className').value.trim();
            
            if (!name) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∫–ª–∞—Å—É');
                return;
            }

            const newClass = {
                id: nextClassId++,
                name: name
            };

            classes.push(newClass);
            schedules[newClass.id] = {};
            
            document.getElementById('className').value = '';
            renderClasses();
            renderSchedules();
            
            // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            saveToLocalStorage();
        }

        function removeClass(id) {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–ª–∞—Å?')) {
                classes = classes.filter(c => c.id !== id);
                delete schedules[id];
                renderClasses();
                renderSchedules();
                
                // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                saveToLocalStorage();
            }
        }

        function editClass(id) {
            const classItem = classes.find(c => c.id === id);
            if (!classItem) return;
            
            // –ó–∞–ø–∏—Ç—É—î–º–æ –Ω–æ–≤—É –Ω–∞–∑–≤—É –∫–ª–∞—Å—É
            const newName = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É –Ω–∞–∑–≤—É –∫–ª–∞—Å—É:', classItem.name);
            if (newName === null) return; // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ "–°–∫–∞—Å—É–≤–∞—Ç–∏"
            
            const trimmedName = newName.trim();
            if (!trimmedName) {
                alert('‚ö†Ô∏è –ù–∞–∑–≤–∞ –∫–ª–∞—Å—É –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é');
                return;
            }
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä—É –Ω–∞–∑–≤—É
            const oldName = classItem.name;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–∑–≤—É –∫–ª–∞—Å—É
            classItem.name = trimmedName;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderClasses();
            renderSchedules();
            
            // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            saveToLocalStorage();
            
            alert(`‚úÖ –ö–ª–∞—Å –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–æ!\n\n"${oldName}" ‚Üí "${trimmedName}"`);
        }

        function addSubject() {
            const name = document.getElementById('subjectName').value.trim();
            const teacher = document.getElementById('teacherName').value.trim();
            const hours = parseInt(document.getElementById('hoursPerWeek').value);

            if (!name || !teacher || !hours) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
                return;
            }

            const newSubject = {
                id: nextSubjectId++,
                name: name,
                teacher: teacher,
                hours: hours
            };

            subjects.push(newSubject);
            
            document.getElementById('subjectName').value = '';
            document.getElementById('teacherName').value = '';
            document.getElementById('hoursPerWeek').value = '';
            
            renderSubjects();
            renderSchedules();
            
            // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            saveToLocalStorage();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ –∑–≤—ñ—Ç–∞—Ö
            updateTeachersList();
        }

        function removeSubject(id) {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø—Ä–µ–¥–º–µ—Ç?')) {
                subjects = subjects.filter(s => s.id !== id);
                
                Object.keys(schedules).forEach(classId => {
                    Object.keys(schedules[classId]).forEach(key => {
                        if (schedules[classId][key].subjectId === id) {
                            delete schedules[classId][key];
                        }
                    });
                });
                
                renderSubjects();
                renderSchedules();
                
                // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                saveToLocalStorage();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ –∑–≤—ñ—Ç–∞—Ö
                updateTeachersList();
            }
        }

        function editSubject(id) {
            const subject = subjects.find(s => s.id === id);
            if (!subject) return;
            
            // –ó–∞–ø–∏—Ç—É—î–º–æ –Ω–æ–≤—É –Ω–∞–∑–≤—É –ø—Ä–µ–¥–º–µ—Ç—É
            const newName = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É –Ω–∞–∑–≤—É –ø—Ä–µ–¥–º–µ—Ç—É:', subject.name);
            if (newName === null) return; // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ "–°–∫–∞—Å—É–≤–∞—Ç–∏"
            
            const trimmedName = newName.trim();
            if (!trimmedName) {
                alert('‚ö†Ô∏è –ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é');
                return;
            }
            
            // –ó–∞–ø–∏—Ç—É—î–º–æ –Ω–æ–≤–µ —ñ–º'—è –≤—á–∏—Ç–µ–ª—è
            const newTeacher = prompt('–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è –≤—á–∏—Ç–µ–ª—è:', subject.teacher);
            if (newTeacher === null) return; // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ "–°–∫–∞—Å—É–≤–∞—Ç–∏"
            
            const trimmedTeacher = newTeacher.trim();
            if (!trimmedTeacher) {
                alert('‚ö†Ô∏è –Ü–º\'—è –≤—á–∏—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º');
                return;
            }
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É
            const oldName = subject.name;
            const oldTeacher = subject.teacher;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–µ–¥–º–µ—Ç
            subject.name = trimmedName;
            subject.teacher = trimmedTeacher;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –≤—Å—ñ —É—Ä–æ–∫–∏ –≤ —Ä–æ–∑–∫–ª–∞–¥—ñ
            Object.keys(schedules).forEach(classId => {
                Object.keys(schedules[classId]).forEach(key => {
                    const lesson = schedules[classId][key];
                    
                    if (Array.isArray(lesson)) {
                        // –û–±—Ä–æ–±–ª—è—î–º–æ –ø—ñ–¥–≥—Ä—É–ø–∏
                        lesson.forEach(les => {
                            if (les.subjectId === id) {
                                les.name = trimmedName;
                                les.teacher = trimmedTeacher;
                            }
                        });
                    } else if (lesson && lesson.subjectId === id) {
                        // –ó–≤–∏—á–∞–π–Ω–∏–π —É—Ä–æ–∫
                        lesson.name = trimmedName;
                        lesson.teacher = trimmedTeacher;
                    }
                });
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderSubjects();
            renderSchedules();
            
            // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            saveToLocalStorage();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ –∑–≤—ñ—Ç–∞—Ö
            updateTeachersList();
            
            alert(`‚úÖ –ü—Ä–µ–¥–º–µ—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!\n\n"${oldName}" (${oldTeacher})\n‚Üì\n"${trimmedName}" (${trimmedTeacher})`);
        }

        function renderClasses() {
            const list = document.getElementById('classList');
            
            if (classes.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">–ù–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤</p>';
                return;
            }

            list.innerHTML = classes.map(cls => `
                <div class="class-card">
                    <h3>${cls.name}</h3>
                    <div class="class-card-actions">
                        <button class="btn btn-primary" onclick="editClass(${cls.id})" style="padding: 8px 12px;">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                        <button class="btn btn-danger" onclick="removeClass(${cls.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </div>
                </div>
            `).join('');
        }

        function renderSubjects() {
            const list = document.getElementById('subjectList');
            const statsDiv = document.getElementById('subjectsStats');
            
            if (subjects.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">–ù–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</p>';
                statsDiv.style.display = 'none';
                return;
            }

            // –ü–æ–∫–∞–∑—É—î–º–æ —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            statsDiv.style.display = 'block';
            
            // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤
            const uniqueTeachers = new Set(subjects.map(s => s.teacher)).size;
            
            // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ —Å—É–º–∞—Ä–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω
            const totalHours = subjects.reduce((sum, s) => sum + s.hours, 0);
            
            document.getElementById('totalSubjects').textContent = subjects.length;
            document.getElementById('totalTeachers').textContent = uniqueTeachers;
            document.getElementById('totalHours').textContent = totalHours;

            list.innerHTML = subjects.map(subject => {
                let usedCount = 0;
                classes.forEach(cls => {
                    const schedule = schedules[cls.id] || {};
                    Object.values(schedule).forEach(slot => {
                        if (Array.isArray(slot)) {
                            usedCount += slot.filter(s => s.subjectId === subject.id).length;
                        } else if (slot && slot.subjectId === subject.id) {
                            usedCount++;
                        }
                    });
                });

                const color = getSubjectColor(subject.id);
                const tiles = [];
                
                for (let i = 0; i < subject.hours; i++) {
                    const isUsed = i < usedCount;
                    tiles.push(`
                        <div class="lesson-tile ${isUsed ? 'used' : ''}" 
                             draggable="${!isUsed}"
                             data-subject-id="${subject.id}"
                             data-tile-index="${i}"
                             style="background: ${color};">
                            ${subject.name}
                        </div>
                    `);
                }
                
                return `
                    <div class="subject-item">
                        <div class="subject-header">
                            <div class="subject-info">
                                <div class="subject-name">${subject.name}</div>
                                <div class="subject-teacher">–í—á–∏—Ç–µ–ª—å: ${subject.teacher}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span class="subject-hours">${usedCount}/${subject.hours} –≥–æ–¥</span>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn-hour-control" onclick="changeSubjectHours(${subject.id}, -1, event);" title="–ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">‚àí</button>
                                    <button class="btn-hour-control" onclick="changeSubjectHours(${subject.id}, 1, event);" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">+</button>
                                </div>
                                <button class="btn btn-primary" onclick="editSubject(${subject.id})" style="padding: 8px 12px;">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                                <button class="btn btn-danger" onclick="removeSubject(${subject.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </div>
                        </div>
                        <div class="tiles-container" 
                             data-subject-id="${subject.id}">
                            ${tiles.join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
            attachTileDragHandlers();
        }

        function renderSchedules() {
            const content = document.getElementById('scheduleContent');
            
            if (classes.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –∫–ª–∞—Å–∏</h3>
                        <p>–ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ö–ª–∞—Å–∏" —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –∫–ª–∞—Å–∏</p>
                    </div>
                `;
                return;
            }

            if (subjects.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç–∏</h3>
                        <p>–ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ü—Ä–µ–¥–º–µ—Ç–∏ —ñ –≤—á–∏—Ç–µ–ª—ñ" —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç–∏</p>
                    </div>
                `;
                return;
            }

            // –ì–µ–Ω–µ—Ä—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –ø–ª–∏—Ç–æ—á–∫–∏
            let tilesHtml = '';
            let hasAvailableLessons = false;
            
            // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –≤–∑–∞–≥–∞–ª—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —É—Ä–æ–∫–∏
            subjects.forEach(subject => {
                let usedCount = 0;
                classes.forEach(cls => {
                    const schedule = schedules[cls.id] || {};
                    Object.values(schedule).forEach(slot => {
                        if (Array.isArray(slot)) {
                            usedCount += slot.filter(s => s.subjectId === subject.id).length;
                        } else if (slot && slot.subjectId === subject.id) {
                            usedCount++;
                        }
                    });
                });
                
                const availableCount = subject.hours - usedCount;
                if (availableCount > 0) {
                    hasAvailableLessons = true;
                }
            });
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –±–ª–æ–∫ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –¥–æ—Å—Ç—É–ø–Ω—ñ —É—Ä–æ–∫–∏
            if (hasAvailableLessons) {
                tilesHtml = '<div class="available-tiles-section"><h2>–î–æ—Å—Ç—É–ø–Ω—ñ —É—Ä–æ–∫–∏ –¥–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è</h2>';
                
                subjects.forEach(subject => {
                    let usedCount = 0;
                    classes.forEach(cls => {
                        const schedule = schedules[cls.id] || {};
                        Object.values(schedule).forEach(slot => {
                            if (Array.isArray(slot)) {
                                usedCount += slot.filter(s => s.subjectId === subject.id).length;
                            } else if (slot && slot.subjectId === subject.id) {
                                usedCount++;
                            }
                        });
                    });
                    
                    const availableCount = subject.hours - usedCount;
                    const color = getSubjectColor(subject.id);
                    
                    // –ü–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–∏ –∑ –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ —É—Ä–æ–∫–∞–º–∏
                    if (availableCount > 0) {
                        tilesHtml += `
                            <div class="subject-item" style="margin-bottom: 15px;">
                                <div class="subject-header">
                                    <div class="subject-info">
                                        <div class="subject-name">${subject.name}</div>
                                        <div class="subject-teacher">–í—á–∏—Ç–µ–ª—å: ${subject.teacher} ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: ${availableCount} –∑ ${subject.hours}</div>
                                    </div>
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        <button class="btn-hour-control" onclick="changeSubjectHours(${subject.id}, -1, event);" title="–ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">‚àí</button>
                                        <button class="btn-hour-control" onclick="changeSubjectHours(${subject.id}, 1, event);" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">+</button>
                                    </div>
                                </div>
                                <div class="tiles-container" data-subject-id="${subject.id}">
                        `;
                        
                        for (let i = 0; i < availableCount; i++) {
                            tilesHtml += `
                                <div class="lesson-tile" 
                                     draggable="true"
                                     data-subject-id="${subject.id}"
                                     style="background: ${color};">
                                    ${subject.name}
                                </div>
                            `;
                        }
                        
                        tilesHtml += '</div></div>';
                    }
                });
                
                tilesHtml += '</div>';
            }

            // –ì–µ–Ω–µ—Ä—É—î–º–æ —Ä–æ–∑–∫–ª–∞–¥
            let schedulesHtml = '<div class="schedules-container">';
            
            schedulesHtml += `
                <div class="class-schedule-section">
                    <div class="class-schedule-title">–†–æ–∑–∫–ª–∞–¥ —É—Ä–æ–∫—ñ–≤</div>
                    <div class="schedule-wrapper">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>–î–µ–Ω—å</th>
                                    <th>–£—Ä–æ–∫</th>
                                    ${classes.map(cls => `<th>${cls.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
            `;

            days.forEach((day, dayIndex) => {
                for (let i = 1; i <= lessons; i++) {
                    schedulesHtml += `<tr>`;
                    
                    if (i === 1) {
                        schedulesHtml += `<td rowspan="${lessons}" class="day-${dayIndex}" style="font-weight: 600; vertical-align: middle;">${day}</td>`;
                    }
                    
                    schedulesHtml += `<td class="lesson-number">${i}</td>`;
                    
                    classes.forEach(cls => {
                        const key = `${dayIndex}-${i-1}`;
                        const lesson = schedules[cls.id][key];
                        
                        schedulesHtml += `<td>`;
                        
                        if (lesson) {
                            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –º–∞—Å–∏–≤ —É—Ä–æ–∫—ñ–≤ (–ø—ñ–¥–≥—Ä—É–ø–∏)
                            if (Array.isArray(lesson)) {
                                schedulesHtml += `<div class="multiple-lessons">`;
                                lesson.forEach((les, idx) => {
                                    const color = getSubjectColor(les.subjectId);
                                    schedulesHtml += `
                                        <div class="lesson-card lesson-card-split" draggable="true" 
                                             data-subject-id="${les.subjectId}"
                                             data-from-schedule="true"
                                             data-class-id="${cls.id}"
                                             data-day="${dayIndex}"
                                             data-lesson="${i-1}"
                                             style="background: ${color}; position: relative; margin-bottom: ${idx < lesson.length - 1 ? '4px' : '0'};">
                                            <button class="delete-lesson-btn" onclick="deleteLesson(${cls.id}, ${dayIndex}, ${i-1}, ${les.subjectId}); event.stopPropagation();" title="–í–∏–¥–∞–ª–∏—Ç–∏ —É—Ä–æ–∫">√ó</button>
                                            <div class="lesson-card-subject">${les.name}</div>
                                            <div class="lesson-card-teacher">${les.teacher}</div>
                                        </div>
                                    `;
                                });
                                schedulesHtml += `</div>`;
                            } else {
                                // –û–¥–∏–Ω —É—Ä–æ–∫
                                const color = getSubjectColor(lesson.subjectId);
                                schedulesHtml += `
                                    <div class="lesson-card" draggable="true" 
                                         data-subject-id="${lesson.subjectId}"
                                         data-from-schedule="true"
                                         data-class-id="${cls.id}"
                                         data-day="${dayIndex}"
                                         data-lesson="${i-1}"
                                         style="background: ${color}; position: relative;">
                                        <button class="delete-lesson-btn" onclick="deleteLesson(${cls.id}, ${dayIndex}, ${i-1}); event.stopPropagation();" title="–í–∏–¥–∞–ª–∏—Ç–∏ —É—Ä–æ–∫">√ó</button>
                                        <div class="lesson-card-subject">${lesson.name}</div>
                                        <div class="lesson-card-teacher">${lesson.teacher}</div>
                                    </div>
                                `;
                            }
                        } else {
                            schedulesHtml += `
                                <div class="lesson-slot" 
                                     data-class-id="${cls.id}"
                                     data-day="${dayIndex}" 
                                     data-lesson="${i-1}">
                                </div>
                            `;
                        }
                        
                        schedulesHtml += `</td>`;
                    });
                    
                    schedulesHtml += '</tr>';
                }
            });

            schedulesHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            schedulesHtml += '</div>';
            content.innerHTML = tilesHtml + schedulesHtml;
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏
            attachScheduleDragHandlers();
        }

        let draggedElement = null;
        let draggedSubjectId = null;
        let fromSchedule = false;
        let originalSlot = null;
        let savedScrollPositions = { 
            content: 0, 
            wrapper: { top: 0, left: 0 },
            availableTiles: 0
        };

        function attachTileDragHandlers() {
            const tiles = document.querySelectorAll('.lesson-tile[draggable="true"]');
            tiles.forEach(tile => {
                tile.addEventListener('dragstart', handleTileDragStart);
                tile.addEventListener('dragend', handleDragEnd);
            });

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –ø–ª–∏—Ç–æ–∫
            const containers = document.querySelectorAll('.tiles-container');
            containers.forEach(container => {
                container.addEventListener('dragover', handleContainerDragOver);
                container.addEventListener('dragleave', handleContainerDragLeave);
                container.addEventListener('drop', handleContainerDrop);
            });
        }

        function attachScheduleDragHandlers() {
            const tiles = document.querySelectorAll('.lesson-tile[draggable="true"]');
            tiles.forEach(tile => {
                tile.addEventListener('dragstart', handleTileDragStart);
                tile.addEventListener('dragend', handleDragEnd);
            });

            const cards = document.querySelectorAll('.lesson-card[draggable="true"]');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleCardDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            const slots = document.querySelectorAll('.lesson-slot');
            slots.forEach(slot => {
                slot.addEventListener('dragover', handleSlotDragOver);
                slot.addEventListener('dragleave', handleSlotDragLeave);
                slot.addEventListener('drop', handleSlotDrop);
            });

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–æ –≤—Å—ñ—Ö td –≤ —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–∑–∫–ª–∞–¥—É (–∫—Ä—ñ–º –ø–µ—Ä—à–∏—Ö –¥–≤–æ—Ö –∫–æ–ª–æ–Ω–æ–∫)
            const scheduleTds = document.querySelectorAll('.schedule-table tbody td:not(.lesson-number):not(:first-child)');
            scheduleTds.forEach(td => {
                // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ td –∑ lesson-slot (–≤–æ–Ω–∏ –≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω—ñ)
                if (td.querySelector('.lesson-slot')) return;
                
                td.addEventListener('dragover', handleTdDragOver);
                td.addEventListener('dragleave', handleTdDragLeave);
                td.addEventListener('drop', handleTdDrop);
            });

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –ø–ª–∏—Ç–æ–∫
            const containers = document.querySelectorAll('.tiles-container');
            containers.forEach(container => {
                container.addEventListener('dragover', handleContainerDragOver);
                container.addEventListener('dragleave', handleContainerDragLeave);
                container.addEventListener('drop', handleContainerDrop);
            });
        }

        function handleTileDragStart(e) {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—Ä–∏ –ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
            const scheduleContent = document.getElementById('scheduleContent');
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            const availableTiles = document.querySelector('.available-tiles-section');
            
            if (scheduleContent) savedScrollPositions.content = scheduleContent.scrollTop;
            if (scheduleWrapper) {
                savedScrollPositions.wrapper.top = scheduleWrapper.scrollTop;
                savedScrollPositions.wrapper.left = scheduleWrapper.scrollLeft;
            }
            if (availableTiles) savedScrollPositions.availableTiles = availableTiles.scrollTop;
            
            draggedElement = e.target;
            draggedSubjectId = parseInt(e.target.dataset.subjectId);
            fromSchedule = false;
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleCardDragStart(e) {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—Ä–∏ –ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
            const scheduleContent = document.getElementById('scheduleContent');
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            const availableTiles = document.querySelector('.available-tiles-section');
            
            if (scheduleContent) savedScrollPositions.content = scheduleContent.scrollTop;
            if (scheduleWrapper) {
                savedScrollPositions.wrapper.top = scheduleWrapper.scrollTop;
                savedScrollPositions.wrapper.left = scheduleWrapper.scrollLeft;
            }
            if (availableTiles) savedScrollPositions.availableTiles = availableTiles.scrollTop;
            
            draggedElement = e.target;
            draggedSubjectId = parseInt(e.target.dataset.subjectId);
            fromSchedule = true;
            
            originalSlot = {
                classId: parseInt(e.target.dataset.classId),
                day: e.target.dataset.day,
                lesson: e.target.dataset.lesson
            };
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleSlotDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
            const scheduleContent = document.getElementById('scheduleContent');
            const availableTiles = document.querySelector('.available-tiles-section');
            
            if (scheduleContent && savedScrollPositions.content !== scheduleContent.scrollTop) {
                scheduleContent.scrollTop = savedScrollPositions.content;
            }
            if (availableTiles && savedScrollPositions.availableTiles !== availableTiles.scrollTop) {
                availableTiles.scrollTop = savedScrollPositions.availableTiles;
            }
        }

        function handleSlotDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleTdDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const lessonCard = e.currentTarget.querySelector('.lesson-card, .multiple-lessons');
            if (lessonCard) {
                lessonCard.classList.add('drag-over');
            }
            e.dataTransfer.dropEffect = 'move';
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
            const scheduleContent = document.getElementById('scheduleContent');
            const availableTiles = document.querySelector('.available-tiles-section');
            
            if (scheduleContent && savedScrollPositions.content !== scheduleContent.scrollTop) {
                scheduleContent.scrollTop = savedScrollPositions.content;
            }
            if (availableTiles && savedScrollPositions.availableTiles !== availableTiles.scrollTop) {
                availableTiles.scrollTop = savedScrollPositions.availableTiles;
            }
        }

        function handleTdDragLeave(e) {
            e.stopPropagation();
            const lessonCard = e.currentTarget.querySelector('.lesson-card, .multiple-lessons');
            if (lessonCard) {
                lessonCard.classList.remove('drag-over');
            }
        }

        function handleTdDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const td = e.currentTarget;
            const lessonCard = td.querySelector('.lesson-card, .multiple-lessons');
            if (lessonCard) {
                lessonCard.classList.remove('drag-over');
            }
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –ø–µ—Ä—à–æ–≥–æ lesson-card –≤ td
            const firstCard = td.querySelector('.lesson-card');
            if (!firstCard) return;
            
            const classId = parseInt(firstCard.dataset.classId);
            const day = firstCard.dataset.day;
            const lesson = firstCard.dataset.lesson;
            const key = `${day}-${lesson}`;
            
            const schedule = schedules[classId];
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –û–ë–û–• –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            const scheduleContent = document.getElementById('scheduleContent');
            const wrapperScrollTop = scheduleWrapper ? scheduleWrapper.scrollTop : 0;
            const wrapperScrollLeft = scheduleWrapper ? scheduleWrapper.scrollLeft : 0;
            const contentScrollTop = scheduleContent ? scheduleContent.scrollTop : 0;
            
            // –Ø–∫—â–æ –ø–µ—Ä–µ–º—ñ—â—É—î–º–æ –∑ —Ä–æ–∑–∫–ª–∞–¥—É
            if (fromSchedule && originalSlot) {
                const oldKey = `${originalSlot.day}-${originalSlot.lesson}`;
                const oldLessons = schedules[originalSlot.classId][oldKey];
                
                if (Array.isArray(oldLessons)) {
                    // –í–∏–¥–∞–ª—è—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —É—Ä–æ–∫ –∑ –º–∞—Å–∏–≤—É
                    schedules[originalSlot.classId][oldKey] = oldLessons.filter(l => l.subjectId !== draggedSubjectId);
                    if (schedules[originalSlot.classId][oldKey].length === 0) {
                        delete schedules[originalSlot.classId][oldKey];
                    }
                } else if (oldLessons && oldLessons.subjectId === draggedSubjectId) {
                    delete schedules[originalSlot.classId][oldKey];
                }
            }
            
            // –î–æ–¥–∞—î–º–æ —É—Ä–æ–∫ –¥–æ –Ω–æ–≤–æ–≥–æ —Å–ª–æ—Ç—É
            const subject = subjects.find(s => s.id === draggedSubjectId);
            const newLesson = {
                subjectId: subject.id,
                name: subject.name,
                teacher: subject.teacher
            };
            
            // –Ø–∫—â–æ –≤ —Å–ª–æ—Ç—ñ –≤–∂–µ —î —É—Ä–æ–∫(–∏), –¥–æ–¥–∞—î–º–æ –¥–æ –º–∞—Å–∏–≤—É
            if (schedule[key]) {
                if (Array.isArray(schedule[key])) {
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ç–∞–∫–∏–π —É—Ä–æ–∫ –≤–∂–µ –Ω–µ –¥–æ–¥–∞–Ω–∏–π
                    const exists = schedule[key].some(l => l.subjectId === subject.id);
                    if (!exists) {
                        schedule[key].push(newLesson);
                    }
                } else {
                    // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –≤ –º–∞—Å–∏–≤
                    const existingLesson = schedule[key];
                    if (existingLesson.subjectId !== subject.id) {
                        schedule[key] = [existingLesson, newLesson];
                    }
                }
            } else {
                schedule[key] = newLesson;
            }
            
            renderSchedules();
            renderSubjects();
            
            // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            saveToLocalStorage();
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –î–õ–Ø –í–°–Ü–• –ö–û–ù–¢–ï–ô–ù–ï–†–Ü–í
            setTimeout(() => {
                const newScheduleWrapper = document.querySelector('.schedule-wrapper');
                const newScheduleContent = document.getElementById('scheduleContent');
                const newAvailableTiles = document.querySelector('.available-tiles-section');
                
                if (newScheduleWrapper) {
                    newScheduleWrapper.scrollTop = wrapperScrollTop;
                    newScheduleWrapper.scrollLeft = wrapperScrollLeft;
                }
                if (newScheduleContent) {
                    newScheduleContent.scrollTop = contentScrollTop;
                }
                if (newAvailableTiles && savedScrollPositions.availableTiles !== undefined) {
                    newAvailableTiles.scrollTop = savedScrollPositions.availableTiles;
                }
            }, 0);
        }

        function handleSlotDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const slot = e.currentTarget;
            const classId = parseInt(slot.dataset.classId);
            const day = slot.dataset.day;
            const lesson = slot.dataset.lesson;
            const key = `${day}-${lesson}`;
            
            const schedule = schedules[classId];
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –û–ë–û–• –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            const scheduleContent = document.getElementById('scheduleContent');
            const wrapperScrollTop = scheduleWrapper ? scheduleWrapper.scrollTop : 0;
            const wrapperScrollLeft = scheduleWrapper ? scheduleWrapper.scrollLeft : 0;
            const contentScrollTop = scheduleContent ? scheduleContent.scrollTop : 0;
            
            // –Ø–∫—â–æ –ø–µ—Ä–µ–º—ñ—â—É—î–º–æ –∑ —Ä–æ–∑–∫–ª–∞–¥—É
            if (fromSchedule && originalSlot) {
                const oldKey = `${originalSlot.day}-${originalSlot.lesson}`;
                const oldLessons = schedules[originalSlot.classId][oldKey];
                
                if (Array.isArray(oldLessons)) {
                    // –í–∏–¥–∞–ª—è—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —É—Ä–æ–∫ –∑ –º–∞—Å–∏–≤—É
                    schedules[originalSlot.classId][oldKey] = oldLessons.filter(l => l.subjectId !== draggedSubjectId);
                    if (schedules[originalSlot.classId][oldKey].length === 0) {
                        delete schedules[originalSlot.classId][oldKey];
                    }
                } else if (oldLessons && oldLessons.subjectId === draggedSubjectId) {
                    delete schedules[originalSlot.classId][oldKey];
                }
            }
            
            // –î–æ–¥–∞—î–º–æ —É—Ä–æ–∫ –¥–æ –Ω–æ–≤–æ–≥–æ —Å–ª–æ—Ç—É
            const subject = subjects.find(s => s.id === draggedSubjectId);
            const newLesson = {
                subjectId: subject.id,
                name: subject.name,
                teacher: subject.teacher
            };
            
            // –Ø–∫—â–æ –≤ —Å–ª–æ—Ç—ñ –≤–∂–µ —î —É—Ä–æ–∫(–∏), –¥–æ–¥–∞—î–º–æ –¥–æ –º–∞—Å–∏–≤—É
            if (schedule[key]) {
                if (Array.isArray(schedule[key])) {
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ç–∞–∫–∏–π —É—Ä–æ–∫ –≤–∂–µ –Ω–µ –¥–æ–¥–∞–Ω–∏–π
                    const exists = schedule[key].some(l => l.subjectId === subject.id);
                    if (!exists) {
                        schedule[key].push(newLesson);
                    }
                } else {
                    // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –≤ –º–∞—Å–∏–≤
                    const existingLesson = schedule[key];
                    if (existingLesson.subjectId !== subject.id) {
                        schedule[key] = [existingLesson, newLesson];
                    }
                }
            } else {
                schedule[key] = newLesson;
            }
            
            renderSchedules();
            renderSubjects();
            
            // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            saveToLocalStorage();
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –î–õ–Ø –í–°–Ü–• –ö–û–ù–¢–ï–ô–ù–ï–†–Ü–í
            setTimeout(() => {
                const newScheduleWrapper = document.querySelector('.schedule-wrapper');
                const newScheduleContent = document.getElementById('scheduleContent');
                const newAvailableTiles = document.querySelector('.available-tiles-section');
                
                if (newScheduleWrapper) {
                    newScheduleWrapper.scrollTop = wrapperScrollTop;
                    newScheduleWrapper.scrollLeft = wrapperScrollLeft;
                }
                if (newScheduleContent) {
                    newScheduleContent.scrollTop = contentScrollTop;
                }
                if (newAvailableTiles && savedScrollPositions.availableTiles !== undefined) {
                    newAvailableTiles.scrollTop = savedScrollPositions.availableTiles;
                }
            }, 0);
        }

        function handleContainerDragOver(e) {
            // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
            e.dataTransfer.dropEffect = 'none';
        }

        function handleContainerDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleContainerDrop(e) {
            // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ drop –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
            e.preventDefault();
            return false;
        }

        // –§—É–Ω–∫—Ü—ñ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        function changeSubjectHours(subjectId, change, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            const newHours = subject.hours + change;
            
            if (newHours < 1) {
                alert('‚ö†Ô∏è –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –º–µ–Ω—à–µ 1');
                return;
            }
            
            let usedCount = 0;
            classes.forEach(cls => {
                const schedule = schedules[cls.id] || {};
                Object.values(schedule).forEach(slot => {
                    if (Array.isArray(slot)) {
                        usedCount += slot.filter(s => s.subjectId === subject.id).length;
                    } else if (slot && slot.subjectId === subject.id) {
                        usedCount++;
                    }
                });
            });
            
            if (change < 0 && newHours < usedCount) {
                alert(`‚ö†Ô∏è –ù–µ–º–æ–∂–ª–∏–≤–æ –∑–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω –¥–æ ${newHours}, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ ${usedCount} –≥–æ–¥–∏–Ω –≤ —Ä–æ–∑–∫–ª–∞–¥—ñ. –°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª—ñ—Ç—å –¥–µ—è–∫—ñ —É—Ä–æ–∫–∏ –∑ —Ä–æ–∑–∫–ª–∞–¥—É.`);
                return;
            }
            
            // –ó–ú–Ü–ù–Æ–Ñ–ú–û –ó–ù–ê–ß–ï–ù–ù–Ø
            subject.hours = newHours;
            const availableCount = newHours - usedCount;
            
            // –ü–ï–†–ï–í–Ü–†–Ø–Ñ–ú–û –ß–ò –ü–û–¢–†–Ü–ë–ù–û –ü–û–ö–ê–ó–ê–¢–ò/–ü–†–ò–•–û–í–ê–¢–ò –ë–õ–û–ö available-tiles-section
            let hasAvailableLessons = false;
            subjects.forEach(s => {
                let used = 0;
                classes.forEach(cls => {
                    const schedule = schedules[cls.id] || {};
                    Object.values(schedule).forEach(slot => {
                        if (Array.isArray(slot)) {
                            used += slot.filter(lesson => lesson.subjectId === s.id).length;
                        } else if (slot && slot.subjectId === s.id) {
                            used++;
                        }
                    });
                });
                if (s.hours - used > 0) {
                    hasAvailableLessons = true;
                }
            });
            
            // –Ø–∫—â–æ –±–ª–æ–∫ —Ç—Ä–µ–±–∞ –ø–æ–∫–∞–∑–∞—Ç–∏, –∞–ª–µ –π–æ–≥–æ –Ω–µ–º–∞—î - —Ä–µ–Ω–¥–µ—Ä–∏–º–æ –≤–µ—Å—å —Ä–æ–∑–∫–ª–∞–¥
            const availableTilesSection = document.querySelector('.available-tiles-section');
            const needsSection = hasAvailableLessons;
            const hasSection = availableTilesSection !== null;
            
            if (needsSection && !hasSection) {
                // –ü–æ—Ç—Ä—ñ–±–µ–Ω –±–ª–æ–∫, –∞–ª–µ –π–æ–≥–æ –Ω–µ–º–∞—î - –ø–æ–≤–Ω–∏–π —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
                renderSchedules();
                // –¢–ê–ö–û–ñ –û–ù–û–í–õ–Æ–Ñ–ú–û –í–ö–õ–ê–î–ö–£ –ü–†–ï–î–ú–ï–¢–Ü–í
                renderSubjects();
                // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                saveToLocalStorage();
                return; // –í–∏—Ö–æ–¥–∏–º–æ, –±–æ renderSchedules —ñ renderSubjects –≤—Å–µ –æ–Ω–æ–≤–∏–ª–∏
            } else if (!needsSection && hasSection) {
                // –ë–ª–æ–∫ —î, –∞–ª–µ –≤—ñ–Ω –±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω - –≤–∏–¥–∞–ª—è—î–º–æ –π–æ–≥–æ
                availableTilesSection.remove();
            }
            
            // –û–ù–û–í–õ–Æ–Ñ–ú–û –ë–õ–û–ö –ù–ê –í–ö–õ–ê–î–¶–Ü "–†–û–ó–ö–õ–ê–î" (—è–∫—â–æ –≤—ñ–Ω —î)
            if (availableTilesSection) {
                const scheduleSubjectItems = availableTilesSection.querySelectorAll('.subject-item');
                let subjectItemFound = false;
                
                scheduleSubjectItems.forEach(item => {
                    const subjectIdInDom = item.querySelector('.tiles-container')?.dataset.subjectId;
                    if (subjectIdInDom == subjectId) {
                        subjectItemFound = true;
                        
                        // –Ø–∫—â–æ –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤ - –≤–∏–¥–∞–ª—è—î–º–æ —Ü–µ–π –ø—Ä–µ–¥–º–µ—Ç –∑ –±–ª–æ–∫—É
                        if (availableCount === 0) {
                            item.remove();
                            return;
                        }
                        
                        const teacherDiv = item.querySelector('.subject-teacher');
                        if (teacherDiv) {
                            teacherDiv.textContent = `–í—á–∏—Ç–µ–ª—å: ${subject.teacher} ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: ${availableCount} –∑ ${newHours}`;
                        }
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –ø–ª–∏—Ç–∫–∏
                        const tilesContainer = item.querySelector('.tiles-container');
                        if (tilesContainer) {
                            const color = getSubjectColor(subjectId);
                            let tilesHtml = '';
                            
                            for (let i = 0; i < availableCount; i++) {
                                tilesHtml += `
                                    <div class="lesson-tile" 
                                         draggable="true"
                                         data-subject-id="${subjectId}"
                                         style="background: ${color};">
                                        ${subject.name}
                                    </div>
                                `;
                            }
                            
                            tilesContainer.innerHTML = tilesHtml;
                            attachScheduleDragHandlers();
                        }
                    }
                });
                
                // –Ø–∫—â–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ –±—É–ª–æ –≤ –±–ª–æ–∫—É, –∞–ª–µ —Ç–µ–ø–µ—Ä —î –¥–æ—Å—Ç—É–ø–Ω—ñ —É—Ä–æ–∫–∏ - –¥–æ–¥–∞—î–º–æ –π–æ–≥–æ
                if (!subjectItemFound && availableCount > 0) {
                    const color = getSubjectColor(subjectId);
                    let tilesHtml = '';
                    
                    for (let i = 0; i < availableCount; i++) {
                        tilesHtml += `
                            <div class="lesson-tile" 
                                 draggable="true"
                                 data-subject-id="${subjectId}"
                                 style="background: ${color};">
                                ${subject.name}
                            </div>
                        `;
                    }
                    
                    const newSubjectItem = document.createElement('div');
                    newSubjectItem.className = 'subject-item';
                    newSubjectItem.style.marginBottom = '15px';
                    newSubjectItem.innerHTML = `
                        <div class="subject-header">
                            <div class="subject-info">
                                <div class="subject-name">${subject.name}</div>
                                <div class="subject-teacher">–í—á–∏—Ç–µ–ª—å: ${subject.teacher} ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: ${availableCount} –∑ ${newHours}</div>
                            </div>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <button class="btn-hour-control" onclick="changeSubjectHours(${subjectId}, -1, event);" title="–ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">‚àí</button>
                                <button class="btn-hour-control" onclick="changeSubjectHours(${subjectId}, 1, event);" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">+</button>
                            </div>
                        </div>
                        <div class="tiles-container" data-subject-id="${subjectId}">
                            ${tilesHtml}
                        </div>
                    `;
                    
                    availableTilesSection.appendChild(newSubjectItem);
                    attachScheduleDragHandlers();
                }
            }
            
            // –û–ù–û–í–õ–Æ–Ñ–ú–û –ë–õ–û–ö –ù–ê –í–ö–õ–ê–î–¶–Ü "–ü–†–ï–î–ú–ï–¢–ò –Ü –í–ß–ò–¢–ï–õ–Ü"
            const subjectListItems = document.querySelectorAll('#subjectList .subject-item');
            subjectListItems.forEach(item => {
                const subjectIdInDom = item.querySelector('.tiles-container')?.dataset.subjectId;
                if (subjectIdInDom == subjectId) {
                    // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –≥–æ–¥–∏–Ω
                    const hoursSpan = item.querySelector('.subject-hours');
                    if (hoursSpan) {
                        hoursSpan.textContent = `${usedCount}/${newHours} –≥–æ–¥`;
                    }
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ –ø–ª–∏—Ç–∫–∏
                    const tilesContainer = item.querySelector('.tiles-container');
                    if (tilesContainer) {
                        const color = getSubjectColor(subjectId);
                        let tilesHtml = '';
                        
                        for (let i = 0; i < newHours; i++) {
                            const isUsed = i < usedCount;
                            tilesHtml += `
                                <div class="lesson-tile ${isUsed ? 'used' : ''}" 
                                     draggable="${!isUsed}"
                                     data-subject-id="${subjectId}"
                                     data-tile-index="${i}"
                                     style="background: ${color};">
                                    ${subject.name}
                                </div>
                            `;
                        }
                        
                        tilesContainer.innerHTML = tilesHtml;
                        attachTileDragHandlers();
                    }
                }
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –≤–∫–ª–∞–¥—Ü—ñ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
            const totalHours = subjects.reduce((sum, s) => sum + s.hours, 0);
            const totalHoursElement = document.getElementById('totalHours');
            if (totalHoursElement) {
                totalHoursElement.textContent = totalHours;
            }
            
            // Blur –∫–Ω–æ–ø–∫–∏
            if (event && event.target) {
                event.target.blur();
            }
            
            // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            saveToLocalStorage();
        }

        function clearDemoData() {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ (–∫–ª–∞—Å–∏, –ø—Ä–µ–¥–º–µ—Ç–∏, —Ä–æ–∑–∫–ª–∞–¥)?')) {
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const scheduleContent = document.getElementById('scheduleContent');
                const scrollTop = scheduleContent ? scheduleContent.scrollTop : 0;
                
                classes = [];
                subjects = [];
                schedules = {};
                nextClassId = 1;
                nextSubjectId = 1;
                
                renderClasses();
                renderSubjects();
                renderSchedules();
                
                // –û—á–∏—â–∞—î–º–æ localStorage
                clearLocalStorage();
                
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                setTimeout(() => {
                    if (scheduleContent) {
                        scheduleContent.scrollTop = scrollTop;
                    }
                }, 0);
                
                alert('‚úÖ –í—Å—ñ –¥–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ!');
            }
        }

        function deleteLesson(classId, day, lesson, subjectId = null) {
            const key = `${day}-${lesson}`;
            
            if (schedules[classId] && schedules[classId][key]) {
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const scheduleWrapper = document.querySelector('.schedule-wrapper');
                const scrollTop = scheduleWrapper ? scheduleWrapper.scrollTop : 0;
                const scrollLeft = scheduleWrapper ? scheduleWrapper.scrollLeft : 0;
                
                const slot = schedules[classId][key];
                
                // –Ø–∫—â–æ —Ü–µ –º–∞—Å–∏–≤ —É—Ä–æ–∫—ñ–≤ —ñ –≤–∫–∞–∑–∞–Ω–æ subjectId
                if (Array.isArray(slot) && subjectId !== null) {
                    schedules[classId][key] = slot.filter(l => l.subjectId !== subjectId);
                    if (schedules[classId][key].length === 0) {
                        delete schedules[classId][key];
                    }
                } else {
                    // –í–∏–¥–∞–ª—è—î–º–æ –≤–µ—Å—å —Å–ª–æ—Ç
                    delete schedules[classId][key];
                }
                
                renderSchedules();
                renderSubjects();
                
                // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                saveToLocalStorage();
                
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
                setTimeout(() => {
                    const newScheduleWrapper = document.querySelector('.schedule-wrapper');
                    if (newScheduleWrapper) {
                        newScheduleWrapper.scrollTop = scrollTop;
                        newScheduleWrapper.scrollLeft = scrollLeft;
                    }
                }, 0);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –≤ Excel
        function checkTeacherConflicts() {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            const scheduleContent = document.getElementById('scheduleContent');
            const scrollTop = scheduleContent ? scheduleContent.scrollTop : 0;
            
            const conflicts = [];
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–µ–Ω –¥–µ–Ω—å —Ç–∞ —É—Ä–æ–∫
            days.forEach((day, dayIndex) => {
                for (let lessonNum = 0; lessonNum < lessons; lessonNum++) {
                    const key = `${dayIndex}-${lessonNum}`;
                    const teachersInThisSlot = {};
                    
                    // –ó–±–∏—Ä–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ —Ü—å–æ–º—É —Å–ª–æ—Ç—ñ
                    classes.forEach(cls => {
                        const lesson = schedules[cls.id][key];
                        
                        if (lesson) {
                            // –û–±—Ä–æ–±–ª—è—î–º–æ —è–∫ –æ–¥–∏–Ω–æ—á–Ω–∏–π —É—Ä–æ–∫, —Ç–∞–∫ —ñ –º–∞—Å–∏–≤
                            const lessons = Array.isArray(lesson) ? lesson : [lesson];
                            
                            lessons.forEach(les => {
                                if (!teachersInThisSlot[les.teacher]) {
                                    teachersInThisSlot[les.teacher] = [];
                                }
                                teachersInThisSlot[les.teacher].push({
                                    className: cls.name,
                                    subjectName: les.name
                                });
                            });
                        }
                    });
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –≤—á–∏—Ç–µ–ª—ñ —è–∫—ñ –≤–µ–¥—É—Ç—å —É—Ä–æ–∫ —É –±—ñ–ª—å—à –Ω—ñ–∂ –æ–¥–Ω–æ–º—É –∫–ª–∞—Å—ñ
                    Object.keys(teachersInThisSlot).forEach(teacher => {
                        if (teachersInThisSlot[teacher].length > 1) {
                            conflicts.push({
                                day: day,
                                lesson: lessonNum + 1,
                                teacher: teacher,
                                classes: teachersInThisSlot[teacher]
                            });
                        }
                    });
                }
            });
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º alert
            setTimeout(() => {
                if (scheduleContent) {
                    scheduleContent.scrollTop = scrollTop;
                }
            }, 0);
            
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
            if (conflicts.length === 0) {
                alert('‚úÖ –ó–±—ñ–≥—ñ–≤ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ! –†–æ–∑–∫–ª–∞–¥ —Å–∫–ª–∞–¥–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.');
            } else {
                let message = '‚ö†Ô∏è –í–∏—è–≤–ª–µ–Ω–æ –∑–±—ñ–≥–∏:\n\n';
                conflicts.forEach(conflict => {
                    message += `${conflict.day}, –£—Ä–æ–∫ ${conflict.lesson}\n`;
                    message += `–í—á–∏—Ç–µ–ª—å: ${conflict.teacher}\n`;
                    message += `–ö–ª–∞—Å–∏: ${conflict.classes.map(c => `${c.className} (${c.subjectName})`).join(', ')}\n\n`;
                });
                alert(message);
            }
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è alert
            setTimeout(() => {
                if (scheduleContent) {
                    scheduleContent.scrollTop = scrollTop;
                }
            }, 0);
        }

        function exportToExcel() {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            const scheduleContent = document.getElementById('scheduleContent');
            const scrollTop = scheduleContent ? scheduleContent.scrollTop : 0;
            
            if (classes.length === 0 || subjects.length === 0) {
                alert('‚ö†Ô∏è –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –î–æ–¥–∞–π—Ç–µ –∫–ª–∞—Å–∏ —Ç–∞ –ø—Ä–µ–¥–º–µ—Ç–∏.');
                setTimeout(() => {
                    if (scheduleContent) scheduleContent.scrollTop = scrollTop;
                }, 0);
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ SheetJS
            if (typeof XLSX === 'undefined') {
                alert('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ Excel... –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
                setTimeout(() => {
                    if (scheduleContent) scheduleContent.scrollTop = scrollTop;
                }, 0);
                return;
            }

            try {
                // –°—Ç–≤–æ—Ä—é—î–º–æ workbook
                const wb = XLSX.utils.book_new();

                // –°—Ç–≤–æ—Ä—é—î–º–æ –≥–æ–ª–æ–≤–Ω—É —Ç–∞–±–ª–∏—Ü—é - —Ç–æ—á–Ω–∞ –∫–æ–ø—ñ—è —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–∑–∫–ª–∞–¥—É
                const data = [];
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                const headerRow = ['–î–µ–Ω—å', '–£—Ä–æ–∫'];
                classes.forEach(cls => headerRow.push(cls.name));
                data.push(headerRow);

                // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –¥–∞–Ω—ñ –ø–æ –¥–Ω—è—Ö —Ç–∞ —É—Ä–æ–∫–∞–º
                days.forEach((day, dayIndex) => {
                    for (let i = 1; i <= lessons; i++) {
                        const row = [];
                        
                        // –î–æ–¥–∞—î–º–æ –¥–µ–Ω—å —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–µ—Ä—à–æ–≥–æ —É—Ä–æ–∫—É
                        if (i === 1) {
                            row.push(day);
                        } else {
                            row.push(''); // –ü–æ—Ä–æ–∂–Ω—è –∫–ª—ñ—Ç–∏–Ω–∫–∞ –¥–ª—è –æ–±'—î–¥–Ω–∞–Ω–Ω—è
                        }
                        
                        // –ù–æ–º–µ—Ä —É—Ä–æ–∫—É
                        row.push(i);
                        
                        // –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–ª–∞—Å—É
                        classes.forEach(cls => {
                            const key = `${dayIndex}-${i-1}`;
                            const lesson = schedules[cls.id][key];
                            
                            if (lesson) {
                                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –º–∞—Å–∏–≤ —É—Ä–æ–∫—ñ–≤ (–ø—ñ–¥–≥—Ä—É–ø–∏)
                                if (Array.isArray(lesson)) {
                                    // –û–±'—î–¥–Ω—É—î–º–æ –≤—Å—ñ —É—Ä–æ–∫–∏ –≤ –æ–¥–Ω—É –∫–ª—ñ—Ç–∏–Ω–∫—É
                                    const lessonsText = lesson.map(l => `${l.name}\n(${l.teacher})`).join('\n---\n');
                                    row.push(lessonsText);
                                } else {
                                    // –û–¥–∏–Ω —É—Ä–æ–∫
                                    row.push(`${lesson.name}\n(${lesson.teacher})`);
                                }
                            } else {
                                row.push('');
                            }
                        });
                        
                        data.push(row);
                    }
                });

                // –°—Ç–≤–æ—Ä—é—î–º–æ worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
                const colWidths = [
                    { wch: 12 },  // –î–µ–Ω—å
                    { wch: 8 }    // –£—Ä–æ–∫
                ];
                classes.forEach(() => colWidths.push({ wch: 25 })); // –ö–ª–∞—Å–∏
                ws['!cols'] = colWidths;

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∏—Å–æ—Ç—É —Ä—è–¥–∫—ñ–≤
                ws['!rows'] = [];
                for (let i = 0; i < data.length; i++) {
                    ws['!rows'].push({ hpt: i === 0 ? 20 : 50 }); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—à–∏–π, —Ä–µ—à—Ç–∞ –±—ñ–ª—å—à—ñ
                }

                // –û–±'—î–¥–Ω—É—î–º–æ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –¥–ª—è –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è
                if (!ws['!merges']) ws['!merges'] = [];
                
                let currentRow = 1; // –ü–æ—á–∏–Ω–∞—î–º–æ –∑ 1 (0 - –∑–∞–≥–æ–ª–æ–≤–æ–∫)
                days.forEach(() => {
                    // –û–±'—î–¥–Ω—É—î–º–æ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –¥–Ω—è (lessons —Ä—è–¥–∫—ñ–≤)
                    ws['!merges'].push({
                        s: { r: currentRow, c: 0 },
                        e: { r: currentRow + lessons - 1, c: 0 }
                    });
                    currentRow += lessons;
                });

                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Å—Ç–∏–ª—ñ –¥–æ –≤—Å—ñ—Ö –∫–ª—ñ—Ç–∏–Ω–æ–∫
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = { c: C, r: R };
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (!ws[cell_ref]) {
                            ws[cell_ref] = { t: 's', v: '' };
                        }
                        
                        // –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –≤—Å—ñ—Ö –∫–ª—ñ—Ç–∏–Ω–æ–∫
                        ws[cell_ref].s = {
                            alignment: {
                                horizontal: 'center',
                                vertical: 'middle',
                                wrapText: true
                            },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                        
                        // –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
                        if (R === 0) {
                            ws[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: '667eea' }
                            };
                            ws[cell_ref].s.font = {
                                bold: true,
                                color: { rgb: 'FFFFFF' },
                                sz: 12
                            };
                        }
                        // –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–î–µ–Ω—å"
                        else if (C === 0) {
                            ws[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: 'e9ecef' }
                            };
                            ws[cell_ref].s.font = {
                                bold: true,
                                sz: 11
                            };
                        }
                        // –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–£—Ä–æ–∫"
                        else if (C === 1) {
                            ws[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: 'f8f9fa' }
                            };
                            ws[cell_ref].s.font = {
                                bold: true,
                                sz: 11
                            };
                        }
                    }
                }

                // –î–æ–¥–∞—î–º–æ worksheet –¥–æ workbook
                XLSX.utils.book_append_sheet(wb, ws, '–†–æ–∑–∫–ª–∞–¥');

                // –°—Ç–≤–æ—Ä—é—î–º–æ –∞—Ä–∫—É—à –∑—ñ —Å–ø–∏—Å–∫–æ–º –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                const subjectsData = [['–ü—Ä–µ–¥–º–µ—Ç', '–í—á–∏—Ç–µ–ª—å', '–ì–æ–¥–∏–Ω/—Ç–∏–∂–¥–µ–Ω—å', '–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ']];
                subjects.forEach(subject => {
                    let usedCount = 0;
                    classes.forEach(cls => {
                        const schedule = schedules[cls.id] || {};
                        Object.values(schedule).forEach(slot => {
                            if (Array.isArray(slot)) {
                                usedCount += slot.filter(s => s.subjectId === subject.id).length;
                            } else if (slot && slot.subjectId === subject.id) {
                                usedCount++;
                            }
                        });
                    });
                    subjectsData.push([subject.name, subject.teacher, subject.hours, usedCount]);
                });

                const subjectsWs = XLSX.utils.aoa_to_sheet(subjectsData);
                subjectsWs['!cols'] = [{ wch: 25 }, { wch: 25 }, { wch: 15 }, { wch: 15 }];
                
                // –°—Ç–∏–ª—ñ –¥–ª—è –∞—Ä–∫—É—à—É –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                const subjectsRange = XLSX.utils.decode_range(subjectsWs['!ref']);
                for (let R = subjectsRange.s.r; R <= subjectsRange.e.r; ++R) {
                    for (let C = subjectsRange.s.c; C <= subjectsRange.e.c; ++C) {
                        const cell_address = { c: C, r: R };
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (!subjectsWs[cell_ref]) continue;
                        
                        subjectsWs[cell_ref].s = {
                            alignment: {
                                horizontal: 'center',
                                vertical: 'middle'
                            },
                            border: {
                                top: { style: 'thin' },
                                bottom: { style: 'thin' },
                                left: { style: 'thin' },
                                right: { style: 'thin' }
                            }
                        };
                        
                        if (R === 0) {
                            subjectsWs[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: '667eea' }
                            };
                            subjectsWs[cell_ref].s.font = {
                                bold: true,
                                color: { rgb: 'FFFFFF' }
                            };
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, subjectsWs, '–ü—Ä–µ–¥–º–µ—Ç–∏');

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
                const fileName = `rozklad_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                setTimeout(() => {
                    if (scheduleContent) {
                        scheduleContent.scrollTop = scrollTop;
                    }
                }, 0);

                alert('‚úÖ –†–æ–∑–∫–ª–∞–¥ —É—Å–ø—ñ—à–Ω–æ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ –≤ Excel!');
            } catch (error) {
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏
                setTimeout(() => {
                    if (scheduleContent) {
                        scheduleContent.scrollTop = scrollTop;
                    }
                }, 0);
                
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç—ñ –≤ Excel: ' + error.message);
                console.error('–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É:', error);
            }
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ SheetJS
            if (typeof XLSX === 'undefined') {
                alert('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ Excel... –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    console.log('üìä –ê—Ä–∫—É—à—ñ –≤ —Ñ–∞–π–ª—ñ:', workbook.SheetNames);

                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∞—Ä–∫—É—à "–†–æ–∑–∫–ª–∞–¥"
                    if (!workbook.SheetNames.includes('–†–æ–∑–∫–ª–∞–¥')) {
                        alert('‚ö†Ô∏è –£ —Ñ–∞–π–ª—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞—Ä–∫—É—à "–†–æ–∑–∫–ª–∞–¥". –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—é –µ–∫—Å–ø–æ—Ä—Ç—É.');
                        return;
                    }

                    const scheduleSheet = workbook.Sheets['–†–æ–∑–∫–ª–∞–¥'];
                    const scheduleData = XLSX.utils.sheet_to_json(scheduleSheet, { header: 1, defval: '' });

                    console.log('üìã –ó—á–∏—Ç–∞–Ω–æ —Ä—è–¥–∫—ñ–≤:', scheduleData.length);
                    console.log('üìã –ü–µ—Ä—à—ñ 3 —Ä—è–¥–∫–∏:', scheduleData.slice(0, 3));

                    if (scheduleData.length < 2) {
                        alert('‚ö†Ô∏è –§–∞–π–ª –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—É.');
                        return;
                    }

                    // –ó—á–∏—Ç—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–Ω–∞–∑–≤–∏ –∫–ª–∞—Å—ñ–≤)
                    const headers = scheduleData[0];
                    const classNames = headers.slice(2); // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ "–î–µ–Ω—å" —Ç–∞ "–£—Ä–æ–∫"

                    console.log('üéì –ö–ª–∞—Å–∏ –∑ —Ñ–∞–π–ª—É:', classNames);

                    if (classNames.length === 0) {
                        alert('‚ö†Ô∏è –£ —Ñ–∞–π–ª—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–ª–∞—Å—ñ–≤.');
                        return;
                    }

                    // –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –ø—Ä–µ–¥–º–µ—Ç–∏ –°–ü–û–ß–ê–¢–ö–£
                    const newSubjects = [];
                    const subjectMapping = {}; // –í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –Ω–∞–∑–≤–∞-–≤—á–∏—Ç–µ–ª—å -> id
                    let tempSubjectId = 1; // –¢–∏–º—á–∞—Å–æ–≤–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                    
                    if (workbook.SheetNames.includes('–ü—Ä–µ–¥–º–µ—Ç–∏')) {
                        const subjectsSheet = workbook.Sheets['–ü—Ä–µ–¥–º–µ—Ç–∏'];
                        const subjectsData = XLSX.utils.sheet_to_json(subjectsSheet, { header: 1, defval: '' });
                        
                        console.log('üìö –ü—Ä–µ–¥–º–µ—Ç–∏ –∑ —Ñ–∞–π–ª—É:', subjectsData.length - 1);
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                        for (let i = 1; i < subjectsData.length; i++) {
                            const row = subjectsData[i];
                            if (row[0] && row[1]) { // –ù–∞–∑–≤–∞ —Ç–∞ –≤—á–∏—Ç–µ–ª—å
                                const subjectName = row[0].toString().trim();
                                const teacherName = row[1].toString().trim();
                                const hours = parseInt(row[2]) || 1;
                                
                                const newSubject = {
                                    id: tempSubjectId++,
                                    name: subjectName,
                                    teacher: teacherName,
                                    hours: hours
                                };
                                
                                newSubjects.push(newSubject);
                                subjectMapping[`${subjectName}|${teacherName}`] = newSubject;
                                console.log(`  ‚úì ${subjectName} - ${teacherName} (${hours} –≥–æ–¥)`);
                            }
                        }
                    }

                    // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—ñ –∫–ª–∞—Å–∏
                    const newClasses = [];
                    const classMapping = {}; // –í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –Ω–∞–∑–≤–∞ -> id
                    let tempClassId = 1; // –¢–∏–º—á–∞—Å–æ–≤–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ –¥–ª—è –∫–ª–∞—Å—ñ–≤
                    
                    classNames.forEach(className => {
                        if (className && className.trim()) {
                            const newClass = {
                                id: tempClassId++,
                                name: className.trim()
                            };
                            newClasses.push(newClass);
                            classMapping[className.trim()] = newClass.id;
                        }
                    });

                    console.log('üéì –°—Ç–≤–æ—Ä–µ–Ω–æ –∫–ª–∞—Å—ñ–≤:', newClasses.length);

                    // –ü–∞—Ä—Å–∏–º–æ —Ä–æ–∑–∫–ª–∞–¥
                    const newSchedules = {};
                    newClasses.forEach(cls => {
                        newSchedules[cls.id] = {};
                    });

                    let currentDay = null;
                    let dayIndex = -1;
                    let lessonsImported = 0;

                    for (let i = 1; i < scheduleData.length; i++) {
                        const row = scheduleData[i];
                        
                        // –Ø–∫—â–æ —î –¥–µ–Ω—å - —Ü–µ –ø–æ—á–∞—Ç–æ–∫ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
                        if (row[0] && row[0].toString().trim()) {
                            currentDay = row[0].toString().trim();
                            dayIndex = days.indexOf(currentDay);
                            if (dayIndex === -1) {
                                console.warn(`‚ö†Ô∏è –ù–µ–≤—ñ–¥–æ–º–∏–π –¥–µ–Ω—å: ${currentDay}`);
                                continue;
                            }
                            console.log(`üìÖ –î–µ–Ω—å: ${currentDay} (—ñ–Ω–¥–µ–∫—Å ${dayIndex})`);
                        }

                        if (dayIndex === -1) continue;

                        const lessonNum = parseInt(row[1]) - 1; // –ù–æ–º–µ—Ä —É—Ä–æ–∫—É (0-based)
                        if (isNaN(lessonNum) || lessonNum < 0 || lessonNum >= lessons) {
                            continue;
                        }

                        // –û–±—Ä–æ–±–ª—è—î–º–æ –∫–æ–∂–µ–Ω –∫–ª–∞—Å
                        classNames.forEach((className, classIndex) => {
                            const cellValue = row[2 + classIndex];
                            if (!cellValue || cellValue.toString().trim() === '') return;

                            const classId = classMapping[className.trim()];
                            if (!classId) return;

                            const key = `${dayIndex}-${lessonNum}`;
                            
                            // –ü–∞—Ä—Å–∏–º–æ –≤–º—ñ—Å—Ç –∫–ª—ñ—Ç–∏–Ω–∫–∏
                            const parsedLessons = parseLessonCell(cellValue.toString(), newSubjects, subjectMapping, tempSubjectId);
                            tempSubjectId = parsedLessons.nextId; // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫
                            
                            if (parsedLessons.lessons.length === 1) {
                                newSchedules[classId][key] = parsedLessons.lessons[0];
                                lessonsImported++;
                            } else if (parsedLessons.lessons.length > 1) {
                                newSchedules[classId][key] = parsedLessons.lessons;
                                lessonsImported += parsedLessons.lessons.length;
                            }
                        });
                    }

                    console.log('üìñ –Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —É—Ä–æ–∫—ñ–≤:', lessonsImported);
                    console.log('üìö –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤:', newSubjects.length);

                    // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—É
                    const confirmation = confirm(
                        `üì• –Ü–º–ø–æ—Ä—Ç –∑ Excel\n\n` +
                        `–ó–Ω–∞–π–¥–µ–Ω–æ:\n` +
                        `‚Ä¢ –ö–ª–∞—Å—ñ–≤: ${newClasses.length}\n` +
                        `‚Ä¢ –ü—Ä–µ–¥–º–µ—Ç—ñ–≤: ${newSubjects.length}\n` +
                        `‚Ä¢ –£—Ä–æ–∫—ñ–≤ –≤ —Ä–æ–∑–∫–ª–∞–¥—ñ: ${lessonsImported}\n\n` +
                        `–£–≤–∞–≥–∞: –ü–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–º—ñ–Ω–µ–Ω—ñ!\n\n` +
                        `–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —ñ–º–ø–æ—Ä—Ç?`
                    );

                    if (!confirmation) return;

                    // –û–Ω–æ–≤–ª—é—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ ID
                    nextClassId = tempClassId;
                    nextSubjectId = tempSubjectId;

                    // –ó–∞–º—ñ–Ω—é—î–º–æ –¥–∞–Ω—ñ
                    classes = newClasses;
                    subjects = newSubjects;
                    schedules = newSchedules;

                    console.log('‚úÖ –î–∞–Ω—ñ –∑–∞–º—ñ–Ω–µ–Ω–æ');
                    console.log('Classes:', classes);
                    console.log('Subjects:', subjects);
                    console.log('Schedules:', schedules);

                    // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    renderClasses();
                    renderSubjects();
                    renderSchedules();
                    
                    // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                    saveToLocalStorage();
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ –∑–≤—ñ—Ç–∞—Ö
                    updateTeachersList();

                    alert(`‚úÖ –†–æ–∑–∫–ª–∞–¥ —É—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!\n\n–ö–ª–∞—Å—ñ–≤: ${newClasses.length}\n–ü—Ä–µ–¥–º–µ—Ç—ñ–≤: ${newSubjects.length}\n–£—Ä–æ–∫—ñ–≤: ${lessonsImported}`);

                } catch (error) {
                    alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ –∑ Excel: ' + error.message);
                    console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É:', error);
                    console.error('Stack:', error.stack);
                }
            };

            reader.readAsArrayBuffer(file);
            
            // –û—á–∏—â–∞—î–º–æ input
            event.target.value = '';
        }

        function parseLessonCell(cellValue, newSubjects, subjectMapping, currentSubjectId) {
            const lessons = [];
            let nextId = currentSubjectId;
            
            if (!cellValue || cellValue.trim() === '') {
                return { lessons: [], nextId: nextId };
            }
            
            // –†–æ–∑–¥—ñ–ª—è—î–º–æ –ø–æ "---" —è–∫—â–æ —î –∫—ñ–ª—å–∫–∞ —É—Ä–æ–∫—ñ–≤
            const lessonTexts = cellValue.split('---').map(t => t.trim()).filter(t => t.length > 0);
            
            console.log(`  üîç –ü–∞—Ä—Å–∏–Ω–≥ –∫–ª—ñ—Ç–∏–Ω–∫–∏: "${cellValue}" -> ${lessonTexts.length} —É—Ä–æ–∫(—ñ–≤)`);
            
            lessonTexts.forEach(lessonText => {
                if (!lessonText) return;
                
                // –ü–∞—Ä—Å–∏–º–æ —Ñ–æ—Ä–º–∞—Ç: "–ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É\n(–í—á–∏—Ç–µ–ª—å)" –∞–±–æ "–ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É (–í—á–∏—Ç–µ–ª—å)"
                let match = lessonText.match(/^(.+?)\s*[\n\r]+\s*\((.+?)\)\s*$/);
                
                // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É—î–º–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
                if (!match) {
                    match = lessonText.match(/^(.+?)\s*\((.+?)\)\s*$/);
                }
                
                if (match) {
                    const subjectName = match[1].trim();
                    const teacherName = match[2].trim();
                    
                    console.log(`    üìñ –ó–Ω–∞–π–¥–µ–Ω–æ: ${subjectName} - ${teacherName}`);
                    
                    // –®—É–∫–∞—î–º–æ –ø—Ä–µ–¥–º–µ—Ç –≤ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–∏—Ö
                    const key = `${subjectName}|${teacherName}`;
                    let subject = subjectMapping[key];
                    
                    if (!subject) {
                        console.log(`    ‚ûï –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –ø—Ä–µ–¥–º–µ—Ç: ${subjectName}`);
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –ø—Ä–µ–¥–º–µ—Ç
                        subject = {
                            id: nextId++,
                            name: subjectName,
                            teacher: teacherName,
                            hours: 1 // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω
                        };
                        newSubjects.push(subject);
                        subjectMapping[key] = subject;
                    }
                    
                    lessons.push({
                        subjectId: subject.id,
                        name: subject.name,
                        teacher: subject.teacher
                    });
                } else {
                    console.warn(`    ‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ —Ñ–æ—Ä–º–∞—Ç: "${lessonText}"`);
                }
            });
            
            return { lessons: lessons, nextId: nextId };
        }

        // –§—É–Ω–∫—Ü—ñ—ó –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ localStorage
        function saveToLocalStorage() {
            try {
                const data = {
                    classes: classes,
                    subjects: subjects,
                    schedules: schedules,
                    nextClassId: nextClassId,
                    nextSubjectId: nextSubjectId,
                    version: '1.0',
                    lastModified: new Date().toISOString()
                };
                localStorage.setItem('rozklad_data', JSON.stringify(data));
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('rozklad_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
                    classes = data.classes || classes;
                    subjects = data.subjects || subjects;
                    schedules = data.schedules || schedules;
                    nextClassId = data.nextClassId || nextClassId;
                    nextSubjectId = data.nextSubjectId || nextSubjectId;
                    
                    console.log('‚úÖ –î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ localStorage');
                    return true;
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ localStorage:', error);
            }
            return false;
        }

        function clearLocalStorage() {
            try {
                localStorage.removeItem('rozklad_data');
                console.log('‚úÖ localStorage –æ—á–∏—â–µ–Ω–æ');
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è localStorage:', error);
            }
        }

        // –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –ª—É–ø–∏
        let magnifierActive = false;
        let magnifierZoom = 2;

        function toggleMagnifier() {
            magnifierActive = !magnifierActive;
            const magnifier = document.getElementById('magnifier');
            const scheduleContent = document.getElementById('scheduleContent');
            
            if (magnifierActive) {
                magnifier.classList.add('active');
                scheduleContent.classList.add('magnifier-active');
                scheduleContent.addEventListener('mousemove', moveMagnifier);
                scheduleContent.addEventListener('mouseleave', hideMagnifier);
            } else {
                magnifier.classList.remove('active');
                magnifier.style.display = 'none';
                scheduleContent.classList.remove('magnifier-active');
                scheduleContent.removeEventListener('mousemove', moveMagnifier);
                scheduleContent.removeEventListener('mouseleave', hideMagnifier);
            }
        }

        function moveMagnifier(e) {
            const magnifier = document.getElementById('magnifier');
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            
            if (!magnifierActive || !scheduleWrapper) return;
            
            magnifier.style.display = 'block';
            
            // –†–æ–∑–º—ñ—Ä –ª—É–ø–∏
            const magnifierSize = 200;
            const halfSize = magnifierSize / 2;
            
            // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ª—É–ø–∏
            let magnifierX = e.pageX - halfSize;
            let magnifierY = e.pageY - halfSize;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –º–µ–∂—ñ –µ–∫—Ä–∞–Ω—É —Ç–∞ –∫–æ—Ä–∏–≥—É—î–º–æ –ø–æ–∑–∏—Ü—ñ—é
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            
            // –ü—Ä–∞–≤–∞ –º–µ–∂–∞
            if (magnifierX + magnifierSize > scrollX + viewportWidth) {
                magnifierX = scrollX + viewportWidth - magnifierSize - 10;
            }
            // –õ—ñ–≤–∞ –º–µ–∂–∞
            if (magnifierX < scrollX) {
                magnifierX = scrollX + 10;
            }
            // –ù–∏–∂–Ω—è –º–µ–∂–∞
            if (magnifierY + magnifierSize > scrollY + viewportHeight) {
                magnifierY = scrollY + viewportHeight - magnifierSize - 10;
            }
            // –í–µ—Ä—Ö–Ω—è –º–µ–∂–∞
            if (magnifierY < scrollY) {
                magnifierY = scrollY + 10;
            }
            
            // –ü–æ–∑–∏—Ü—ñ–æ–Ω—É—î–º–æ –ª—É–ø—É
            magnifier.style.left = magnifierX + 'px';
            magnifier.style.top = magnifierY + 'px';
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤—ñ–¥–Ω–æ—Å–Ω–æ schedule-wrapper (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É –ø–æ–∑–∏—Ü—ñ—é –∫—É—Ä—Å–æ—Ä–∞)
            const wrapperRect = scheduleWrapper.getBoundingClientRect();
            const mouseX = e.clientX - wrapperRect.left + scheduleWrapper.scrollLeft;
            const mouseY = e.clientY - wrapperRect.top + scheduleWrapper.scrollTop;
            
            // –û—Ç—Ä–∏–º—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é
            const table = scheduleWrapper.querySelector('.schedule-table');
            if (!table) return;
            
            // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –≤–º—ñ—Å—Ç
            magnifier.innerHTML = '';
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–±—ñ–ª—å—à–µ–Ω–æ–≥–æ –≤–º—ñ—Å—Ç—É
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.width = table.offsetWidth + 'px';
            container.style.height = table.offsetHeight + 'px';
            container.style.transform = `scale(${magnifierZoom})`;
            container.style.transformOrigin = '0 0';
            container.style.left = (-mouseX * magnifierZoom + halfSize) + 'px';
            container.style.top = (-mouseY * magnifierZoom + halfSize) + 'px';
            
            // –ö–ª–æ–Ω—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é
            const clone = table.cloneNode(true);
            clone.style.margin = '0';
            
            container.appendChild(clone);
            magnifier.appendChild(container);
        }

        function hideMagnifier() {
            const magnifier = document.getElementById('magnifier');
            magnifier.style.display = 'none';
        }

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∑–≤—ñ—Ç—ñ–≤
        function showFreeTeachers() {
            const dayIndex = document.getElementById('reportDay').value;
            const lessonIndex = document.getElementById('reportLesson').value;
            const resultDiv = document.getElementById('freeTeachersResult');
            
            if (dayIndex === '' || lessonIndex === '') {
                resultDiv.innerHTML = '<p style="color: #dc3545;">‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å —Ç–∏–∂–Ω—è —Ç–∞ –Ω–æ–º–µ—Ä —É—Ä–æ–∫—É</p>';
                return;
            }
            
            const dayName = days[parseInt(dayIndex)];
            const lessonNum = parseInt(lessonIndex) + 1;
            
            // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ—Ö —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤
            const allTeachers = new Set();
            subjects.forEach(subject => {
                allTeachers.add(subject.teacher);
            });
            
            // –ó–±–∏—Ä–∞—î–º–æ –≤—á–∏—Ç–µ–ª—ñ–≤ —è–∫—ñ –≤–∏–∫–ª–∞–¥–∞—é—Ç—å –≤ –æ–±—Ä–∞–Ω–∏–π —á–∞—Å
            const busyTeachers = new Set();
            const key = `${dayIndex}-${lessonIndex}`;
            
            classes.forEach(cls => {
                const lesson = schedules[cls.id][key];
                if (lesson) {
                    if (Array.isArray(lesson)) {
                        lesson.forEach(les => busyTeachers.add(les.teacher));
                    } else {
                        busyTeachers.add(lesson.teacher);
                    }
                }
            });
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—ñ–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤
            const freeTeachers = [...allTeachers].filter(teacher => !busyTeachers.has(teacher));
            
            if (freeTeachers.length === 0) {
                resultDiv.innerHTML = `
                    <div class="report-result">
                        <h4>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</h4>
                        <p style="color: #6c757d;">${dayName}, ${lessonNum} —É—Ä–æ–∫: <strong>–í—Å—ñ –≤—á–∏—Ç–µ–ª—ñ –∑–∞–π–Ω—è—Ç—ñ</strong></p>
                    </div>
                `;
            } else {
                let html = `
                    <div class="report-result">
                        <h4>üìä –í—ñ–ª—å–Ω—ñ –≤—á–∏—Ç–µ–ª—ñ: ${dayName}, ${lessonNum} —É—Ä–æ–∫</h4>
                        <p style="color: #6c757d; margin-bottom: 15px;">–ó–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤: <strong>${freeTeachers.length}</strong></p>
                        <div class="teacher-list">
                `;
                
                freeTeachers.sort().forEach(teacher => {
                    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–º–µ—Ç–∏ —Ü—å–æ–≥–æ –≤—á–∏—Ç–µ–ª—è
                    const teacherSubjects = subjects.filter(s => s.teacher === teacher).map(s => s.name).join(', ');
                    html += `
                        <div class="teacher-item">
                            <span>üë®‚Äçüè´ ${teacher}</span>
                            <span style="font-size: 12px; opacity: 0.9;">${teacherSubjects}</span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;
            }
        }

        function showTeacherSchedule() {
            const teacherName = document.getElementById('reportTeacher').value;
            const resultDiv = document.getElementById('teacherScheduleResult');
            
            if (!teacherName) {
                resultDiv.innerHTML = '<p style="color: #dc3545;">‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è</p>';
                return;
            }
            
            // –ó–±–∏—Ä–∞—î–º–æ —Ä–æ–∑–∫–ª–∞–¥ –≤—á–∏—Ç–µ–ª—è
            const teacherSchedule = {};
            
            days.forEach((day, dayIndex) => {
                teacherSchedule[dayIndex] = {};
                for (let lessonIndex = 0; lessonIndex < lessons; lessonIndex++) {
                    teacherSchedule[dayIndex][lessonIndex] = [];
                }
            });
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –≤—Å—ñ—Ö –∫–ª–∞—Å–∞—Ö —ñ –∑–±–∏—Ä–∞—î–º–æ —É—Ä–æ–∫–∏ –≤—á–∏—Ç–µ–ª—è
            classes.forEach(cls => {
                Object.keys(schedules[cls.id]).forEach(key => {
                    const [dayIndex, lessonIndex] = key.split('-').map(Number);
                    const lesson = schedules[cls.id][key];
                    
                    if (Array.isArray(lesson)) {
                        lesson.forEach(les => {
                            if (les.teacher === teacherName) {
                                teacherSchedule[dayIndex][lessonIndex].push({
                                    className: cls.name,
                                    subjectName: les.name
                                });
                            }
                        });
                    } else if (lesson && lesson.teacher === teacherName) {
                        teacherSchedule[dayIndex][lessonIndex].push({
                            className: cls.name,
                            subjectName: lesson.name
                        });
                    }
                });
            });
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–º–µ—Ç–∏ –≤—á–∏—Ç–µ–ª—è
            const teacherSubjects = subjects.filter(s => s.teacher === teacherName);
            const subjectsText = teacherSubjects.map(s => s.name).join(', ');
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é
            let html = `
                <div class="report-result">
                    <h4>üë®‚Äçüè´ –†–æ–∑–∫–ª–∞–¥ –≤—á–∏—Ç–µ–ª—è: ${teacherName}</h4>
                    <p style="color: #6c757d; margin-bottom: 15px;">–ü—Ä–µ–¥–º–µ—Ç–∏: <strong>${subjectsText}</strong></p>
                    <table class="teacher-schedule-table">
                        <thead>
                            <tr>
                                <th style="width: 80px;">–£—Ä–æ–∫</th>
            `;
            
            days.forEach(day => {
                html += `<th>${day}</th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let lessonIndex = 0; lessonIndex < lessons; lessonIndex++) {
                html += `<tr><td><strong>${lessonIndex + 1}</strong></td>`;
                
                days.forEach((day, dayIndex) => {
                    const lessonsAtTime = teacherSchedule[dayIndex][lessonIndex];
                    
                    if (lessonsAtTime.length > 0) {
                        html += `<td class="has-lesson">`;
                        lessonsAtTime.forEach((lesson, idx) => {
                            html += `
                                <div style="margin-bottom: ${idx < lessonsAtTime.length - 1 ? '5px' : '0'};">
                                    <div>${lesson.subjectName}</div>
                                    <div class="class-name">${lesson.className}</div>
                                </div>
                            `;
                        });
                        html += `</td>`;
                    } else {
                        html += `<td class="no-lesson">–≤—ñ–∫–Ω–æ</td>`;
                    }
                });
                
                html += `</tr>`;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        function updateTeachersList() {
            const teacherSelect = document.getElementById('reportTeacher');
            
            // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ—Ö —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤
            const allTeachers = new Set();
            subjects.forEach(subject => {
                allTeachers.add(subject.teacher);
            });
            
            // –°–æ—Ä—Ç—É—î–º–æ —ñ –≥–µ–Ω–µ—Ä—É—î–º–æ –æ–ø—Ü—ñ—ó
            const sortedTeachers = [...allTeachers].sort();
            
            let html = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤—á–∏—Ç–µ–ª—è --</option>';
            sortedTeachers.forEach(teacher => {
                html += `<option value="${teacher}">${teacher}</option>`;
            });
            
            teacherSelect.innerHTML = html;
        }

        function showTeachersWorkload() {
            const resultDiv = document.getElementById('teachersWorkloadResult');
            
            if (subjects.length === 0) {
                resultDiv.innerHTML = '<p style="color: #dc3545;">‚ö†Ô∏è –ù–µ–º–∞—î –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</p>';
                return;
            }
            
            // –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—á–∏—Ç–µ–ª—ñ–≤
            const teachersData = {};
            
            subjects.forEach(subject => {
                if (!teachersData[subject.teacher]) {
                    teachersData[subject.teacher] = {
                        subjects: [],
                        totalPlanned: 0,
                        totalScheduled: 0
                    };
                }
                
                // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ –≥–æ–¥–∏–Ω–∏
                teachersData[subject.teacher].totalPlanned += subject.hours;
                teachersData[subject.teacher].subjects.push({
                    name: subject.name,
                    hours: subject.hours
                });
            });
            
            // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω–æ —Ä–æ–∑–º—ñ—â–µ–Ω—ñ —É—Ä–æ–∫–∏
            classes.forEach(cls => {
                Object.values(schedules[cls.id]).forEach(slot => {
                    if (Array.isArray(slot)) {
                        slot.forEach(lesson => {
                            const teacher = lesson.teacher;
                            if (teachersData[teacher]) {
                                teachersData[teacher].totalScheduled++;
                            }
                        });
                    } else if (slot) {
                        const teacher = slot.teacher;
                        if (teachersData[teacher]) {
                            teachersData[teacher].totalScheduled++;
                        }
                    }
                });
            });
            
            // –°–æ—Ä—Ç—É—î–º–æ –≤—á–∏—Ç–µ–ª—ñ–≤ –∑–∞ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º (—Å–ø–∞–¥–∞–Ω–Ω—è)
            const sortedTeachers = Object.entries(teachersData).sort((a, b) => b[1].totalPlanned - a[1].totalPlanned);
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–ª—è –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
            const maxHours = Math.max(...sortedTeachers.map(([_, data]) => data.totalPlanned));
            
            // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const totalTeachers = sortedTeachers.length;
            const totalHours = sortedTeachers.reduce((sum, [_, data]) => sum + data.totalPlanned, 0);
            const avgHours = totalHours / totalTeachers;
            const totalScheduledHours = sortedTeachers.reduce((sum, [_, data]) => sum + data.totalScheduled, 0);
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ HTML
            let html = `
                <div class="report-result">
                    <h4>üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${totalTeachers}</div>
                            <div style="color: #6c757d; font-size: 14px;">–í—á–∏—Ç–µ–ª—ñ–≤</div>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${totalHours}</div>
                            <div style="color: #6c757d; font-size: 14px;">–í—Å—å–æ–≥–æ –≥–æ–¥–∏–Ω</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #43a047;">${avgHours.toFixed(1)}</div>
                            <div style="color: #6c757d; font-size: 14px;">–°–µ—Ä–µ–¥–Ω—î –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>
                        </div>
                        <div style="background: #fce4ec; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #e91e63;">${totalScheduledHours}</div>
                            <div style="color: #6c757d; font-size: 14px;">–†–æ–∑–º—ñ—â–µ–Ω–æ –≤ —Ä–æ–∑–∫–ª–∞–¥—ñ</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px;">üë• –î–µ—Ç–∞–ª—å–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ –≤—á–∏—Ç–µ–ª—è—Ö</h4>
                    <table class="workload-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">–í—á–∏—Ç–µ–ª—å</th>
                                <th style="width: 35%;">–ü—Ä–µ–¥–º–µ—Ç–∏</th>
                                <th style="width: 15%; text-align: center;">–ì–æ–¥–∏–Ω/—Ç–∏–∂–¥–µ–Ω—å</th>
                                <th style="width: 20%;">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTeachers.forEach(([teacher, data]) => {
                const percentage = (data.totalPlanned / maxHours) * 100;
                const scheduledPercentage = data.totalScheduled > 0 ? (data.totalScheduled / data.totalPlanned) * 100 : 0;
                
                // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–ª–∞—Å –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                let workloadClass = 'workload-light';
                if (data.totalPlanned > avgHours * 1.2) {
                    workloadClass = 'workload-high';
                } else if (data.totalPlanned > avgHours * 0.8) {
                    workloadClass = 'workload-medium';
                }
                
                const subjectsList = data.subjects.map(s => `${s.name} (${s.hours})`).join(', ');
                
                html += `
                    <tr>
                        <td style="font-weight: 600;">${teacher}</td>
                        <td style="font-size: 13px; color: #6c757d;">${subjectsList}</td>
                        <td style="text-align: center;">
                            <strong style="color: #667eea;">${data.totalScheduled}</strong>/<span style="color: #6c757d;">${data.totalPlanned}</span>
                        </td>
                        <td>
                            <div style="background: #e9ecef; border-radius: 4px; overflow: hidden; height: 20px;">
                                <div class="workload-bar ${workloadClass}" style="width: ${percentage}%;" title="${data.totalPlanned} –≥–æ–¥–∏–Ω"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    <p style="color: #6c757d; font-size: 12px; margin-top: 15px;">
                        üí° –ü—ñ–¥–∫–∞–∑–∫–∞: <span style="color: #43a047;">‚óè</span> –Ω–∏–∑—å–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, 
                        <span style="color: #f57c00;">‚óè</span> —Å–µ—Ä–µ–¥–Ω—î –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, 
                        <span style="color: #e91e63;">‚óè</span> –≤–∏—Å–æ–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                    </p>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É/—ñ–º–ø–æ—Ä—Ç—É –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
        function exportSubjectsToExcel() {
            if (subjects.length === 0) {
                alert('‚ö†Ô∏è –ù–µ–º–∞—î –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞
            if (typeof XLSX === 'undefined') {
                alert('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ Excel... –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
                return;
            }

            // –°—Ç–≤–æ—Ä—é—î–º–æ workbook
            const wb = XLSX.utils.book_new();

            // –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –∞—Ä–∫—É—à—É
            const data = [['–ü—Ä–µ–¥–º–µ—Ç', '–í—á–∏—Ç–µ–ª—å', '–ì–æ–¥–∏–Ω/—Ç–∏–∂–¥–µ–Ω—å']];
            
            subjects.forEach(subject => {
                data.push([
                    subject.name,
                    subject.teacher,
                    subject.hours
                ]);
            });

            // –°—Ç–≤–æ—Ä—é—î–º–æ worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
            ws['!cols'] = [
                { wch: 30 },  // –ü—Ä–µ–¥–º–µ—Ç
                { wch: 25 },  // –í—á–∏—Ç–µ–ª—å
                { wch: 15 }   // –ì–æ–¥–∏–Ω
            ];

            // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Å—Ç–∏–ª—ñ
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (!ws[cell_ref]) {
                        ws[cell_ref] = { t: 's', v: '' };
                    }
                    
                    ws[cell_ref].s = {
                        alignment: {
                            horizontal: 'center',
                            vertical: 'middle',
                            wrapText: true
                        },
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                    
                    // –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    if (R === 0) {
                        ws[cell_ref].s.fill = {
                            patternType: 'solid',
                            fgColor: { rgb: '667eea' }
                        };
                        ws[cell_ref].s.font = {
                            bold: true,
                            color: { rgb: 'FFFFFF' },
                            sz: 12
                        };
                    }
                }
            }

            // –î–æ–¥–∞—î–º–æ worksheet –¥–æ workbook
            XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–µ–¥–º–µ—Ç–∏');

            // –ì–µ–Ω–µ—Ä—É—î–º–æ –Ω–∞–∑–≤—É —Ñ–∞–π–ª—É
            const date = new Date();
            const filename = `Predmety_${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.xlsx`;

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
            XLSX.writeFile(wb, filename);

            alert(`‚úÖ –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ –≤ —Ñ–∞–π–ª ${filename}`);
        }

        function importSubjectsFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ SheetJS
            if (typeof XLSX === 'undefined') {
                alert('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ Excel... –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // –®—É–∫–∞—î–º–æ –∞—Ä–∫—É—à "–ü—Ä–µ–¥–º–µ—Ç–∏" –∞–±–æ –ø–µ—Ä—à–∏–π –∞—Ä–∫—É—à
                    let sheetName = '–ü—Ä–µ–¥–º–µ—Ç–∏';
                    if (!workbook.SheetNames.includes(sheetName)) {
                        sheetName = workbook.SheetNames[0];
                    }

                    const sheet = workbook.Sheets[sheetName];
                    const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    console.log('üìä –Ü–º–ø–æ—Ä—Ç –ø—Ä–µ–¥–º–µ—Ç—ñ–≤:', sheetData);

                    if (sheetData.length < 2) {
                        alert('‚ö†Ô∏è –§–∞–π–ª –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω–∏—Ö');
                        return;
                    }

                    // –ü–∞—Ä—Å–∏–º–æ –ø—Ä–µ–¥–º–µ—Ç–∏ (–ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫)
                    const newSubjects = [];
                    let tempSubjectId = nextSubjectId;

                    for (let i = 1; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        
                        if (!row[0] || !row[1]) continue; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏
                        
                        const subjectName = row[0].toString().trim();
                        const teacherName = row[1].toString().trim();
                        const hours = parseInt(row[2]) || 1;

                        if (subjectName && teacherName) {
                            newSubjects.push({
                                id: tempSubjectId++,
                                name: subjectName,
                                teacher: teacherName,
                                hours: hours
                            });
                        }
                    }

                    if (newSubjects.length === 0) {
                        alert('‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç—É –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É');
                        return;
                    }

                    // –ó–∞–ø–∏—Ç—É—î–º–æ —Ä–µ–∂–∏–º —ñ–º–ø–æ—Ä—Ç—É
                    const mode = confirm(
                        `üì• –Ü–º–ø–æ—Ä—Ç –ø—Ä–µ–¥–º–µ—Ç—ñ–≤\n\n` +
                        `–ó–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤: ${newSubjects.length}\n\n` +
                        `–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "OK" —â–æ–± –ó–ê–ú–Ü–ù–ò–¢–ò —ñ—Å–Ω—É—é—á—ñ –ø—Ä–µ–¥–º–µ—Ç–∏\n` +
                        `–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°–∫–∞—Å—É–≤–∞—Ç–∏" —â–æ–± –î–û–î–ê–¢–ò –¥–æ —ñ—Å–Ω—É—é—á–∏—Ö`
                    );

                    if (mode) {
                        // –ó–ê–ú–Ü–ù–ò–¢–ò - –≤–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ —Ç–∞ —ó—Ö —É—Ä–æ–∫–∏ –∑ —Ä–æ–∑–∫–ª–∞–¥—É
                        const oldSubjectIds = subjects.map(s => s.id);
                        
                        // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ —É—Ä–æ–∫–∏ —Å—Ç–∞—Ä–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –∑ —Ä–æ–∑–∫–ª–∞–¥—É
                        Object.keys(schedules).forEach(classId => {
                            Object.keys(schedules[classId]).forEach(key => {
                                const lesson = schedules[classId][key];
                                if (Array.isArray(lesson)) {
                                    schedules[classId][key] = lesson.filter(l => !oldSubjectIds.includes(l.subjectId));
                                    if (schedules[classId][key].length === 0) {
                                        delete schedules[classId][key];
                                    }
                                } else if (lesson && oldSubjectIds.includes(lesson.subjectId)) {
                                    delete schedules[classId][key];
                                }
                            });
                        });
                        
                        subjects = newSubjects;
                        nextSubjectId = tempSubjectId;
                        
                        alert(`‚úÖ –ü—Ä–µ–¥–º–µ—Ç–∏ –∑–∞–º—ñ–Ω–µ–Ω–æ!\n\n–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ: ${newSubjects.length} –ø—Ä–µ–¥–º–µ—Ç—ñ–≤`);
                    } else {
                        // –î–û–î–ê–¢–ò - –¥–æ–¥–∞—î–º–æ –¥–æ —ñ—Å–Ω—É—é—á–∏—Ö
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –º–∞–ø—É —Å—Ç–∞—Ä–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è ID –≤ —Ä–æ–∑–∫–ª–∞–¥—ñ
                        const subjectMap = {}; // key: "–Ω–∞–∑–≤–∞|–≤—á–∏—Ç–µ–ª—å", value: {oldId, newId}
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –¥—É–±–ª—ñ–∫–∞—Ç–∏
                        newSubjects.forEach(newSubject => {
                            const key = `${newSubject.name}|${newSubject.teacher}`;
                            const existingSubject = subjects.find(s => 
                                s.name === newSubject.name && s.teacher === newSubject.teacher
                            );
                            
                            if (existingSubject) {
                                // –Ø–∫—â–æ –ø—Ä–µ–¥–º–µ—Ç –≤–∂–µ —ñ—Å–Ω—É—î - –æ–Ω–æ–≤–ª—é—î–º–æ –π–æ–≥–æ –≥–æ–¥–∏–Ω–∏
                                existingSubject.hours = newSubject.hours;
                                subjectMap[key] = {
                                    oldId: existingSubject.id,
                                    newId: existingSubject.id,
                                    updated: true
                                };
                            } else {
                                // –ù–æ–≤–∏–π –ø—Ä–µ–¥–º–µ—Ç - –¥–æ–¥–∞—î–º–æ
                                subjects.push(newSubject);
                                subjectMap[key] = {
                                    oldId: null,
                                    newId: newSubject.id,
                                    updated: false
                                };
                            }
                        });
                        
                        nextSubjectId = tempSubjectId;
                        
                        const added = Object.values(subjectMap).filter(m => !m.updated).length;
                        const updated = Object.values(subjectMap).filter(m => m.updated).length;
                        
                        alert(`‚úÖ –ü—Ä–µ–¥–º–µ—Ç–∏ –æ–±—Ä–æ–±–ª–µ–Ω–æ!\n\n–î–æ–¥–∞–Ω–æ –Ω–æ–≤–∏—Ö: ${added}\n–û–Ω–æ–≤–ª–µ–Ω–æ —ñ—Å–Ω—É—é—á–∏—Ö: ${updated}\n–í—Å—å–æ–≥–æ: ${subjects.length} –ø—Ä–µ–¥–º–µ—Ç—ñ–≤`);
                    }

                    // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    renderSubjects();
                    renderSchedules();
                    
                    // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                    saveToLocalStorage();
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ –∑–≤—ñ—Ç–∞—Ö
                    updateTeachersList();

                } catch (error) {
                    alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ –∑ Excel: ' + error.message);
                    console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É:', error);
                    console.error('Stack:', error.stack);
                }
            };

            reader.readAsArrayBuffer(file);
            
            // –û—á–∏—â–∞—î–º–æ input
            event.target.value = '';
        }

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—ñ–≤
        function downloadSubjectsTemplate() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞
            if (typeof XLSX === 'undefined') {
                alert('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ Excel... –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
                return;
            }

            // –°—Ç–≤–æ—Ä—é—î–º–æ workbook
            const wb = XLSX.utils.book_new();

            // –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∞–Ω—ñ –¥–ª—è —à–∞–±–ª–æ–Ω—É –∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏
            const data = [
                ['–ü—Ä–µ–¥–º–µ—Ç', '–í—á–∏—Ç–µ–ª—å', '–ì–æ–¥–∏–Ω/—Ç–∏–∂–¥–µ–Ω—å'],
                ['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.', '5'],
                ['–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', '–ü–µ—Ç—Ä–æ–≤–∞ –û.–ú.', '4'],
                ['–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –í.–ü.', '3'],
                ['–§—ñ–∑–∏–∫–∞', '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ú.–ê.', '2'],
                ['–•—ñ–º—ñ—è', '–ú–æ—Ä–æ–∑–æ–≤–∞ –õ.–í.', '2']
            ];

            // –°—Ç–≤–æ—Ä—é—î–º–æ worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
            ws['!cols'] = [
                { wch: 30 },  // –ü—Ä–µ–¥–º–µ—Ç
                { wch: 25 },  // –í—á–∏—Ç–µ–ª—å
                { wch: 15 }   // –ì–æ–¥–∏–Ω
            ];

            // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Å—Ç–∏–ª—ñ
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (!ws[cell_ref]) {
                        ws[cell_ref] = { t: 's', v: '' };
                    }
                    
                    ws[cell_ref].s = {
                        alignment: {
                            horizontal: 'center',
                            vertical: 'middle',
                            wrapText: true
                        },
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                    
                    // –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    if (R === 0) {
                        ws[cell_ref].s.fill = {
                            patternType: 'solid',
                            fgColor: { rgb: '667eea' }
                        };
                        ws[cell_ref].s.font = {
                            bold: true,
                            color: { rgb: 'FFFFFF' },
                            sz: 12
                        };
                    }
                    // –°—Ç–∏–ª—ñ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ (—Å—ñ—Ä–∏–π —Ñ–æ–Ω)
                    else {
                        ws[cell_ref].s.fill = {
                            patternType: 'solid',
                            fgColor: { rgb: 'f0f0f0' }
                        };
                    }
                }
            }

            // –î–æ–¥–∞—î–º–æ worksheet –¥–æ workbook
            XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–µ–¥–º–µ—Ç–∏');

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
            XLSX.writeFile(wb, 'Shablon_Predmety.xlsx');

            alert('‚úÖ –®–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!\n\n' +
                  'üìù –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:\n' +
                  '1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ñ–∞–π–ª Shablon_Predmety.xlsx\n' +
                  '2. –í–∏–¥–∞–ª—ñ—Ç—å –ø—Ä–∏–∫–ª–∞–¥–∏ (—Ä—è–¥–∫–∏ 2-6)\n' +
                  '3. –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Å–≤–æ—ó–º–∏ –¥–∞–Ω–∏–º–∏:\n' +
                  '   ‚Ä¢ –ü—Ä–µ–¥–º–µ—Ç - –Ω–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É\n' +
                  '   ‚Ä¢ –í—á–∏—Ç–µ–ª—å - –ü–Ü–ë –≤—á–∏—Ç–µ–ª—è\n' +
                  '   ‚Ä¢ –ì–æ–¥–∏–Ω/—Ç–∏–∂–¥–µ–Ω—å - —á–∏—Å–ª–æ\n' +
                  '4. –ó–±–µ—Ä–µ–∂—ñ—Ç—å —Ñ–∞–π–ª\n' +
                  '5. –Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "üì• –Ü–º–ø–æ—Ä—Ç"');
        }

        function downloadScheduleTemplate() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∫–ª–∞—Å–∏
            if (classes.length === 0) {
                alert('‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –∫–ª–∞—Å–∏ –Ω–∞ –≤–∫–ª–∞–¥—Ü—ñ "–ö–ª–∞—Å–∏"');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞
            if (typeof XLSX === 'undefined') {
                alert('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ Excel... –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
                return;
            }

            // –°—Ç–≤–æ—Ä—é—î–º–æ workbook
            const wb = XLSX.utils.book_new();

            // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–æ–∑–∫–ª–∞–¥ –∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
            const data = [];
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            const header = ['–î–µ–Ω—å', '–£—Ä–æ–∫'];
            classes.forEach(cls => {
                header.push(cls.name);
            });
            data.push(header);

            // –ì–µ–Ω–µ—Ä—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–æ–∑–∫–ª–∞–¥
            days.forEach(day => {
                for (let i = 0; i < lessons; i++) {
                    const row = [
                        i === 0 ? day : '',  // –î–µ–Ω—å —Ç—ñ–ª—å–∫–∏ –≤ –ø–µ—Ä—à–æ–º—É —Ä—è–¥–∫—É
                        i + 1                // –ù–æ–º–µ—Ä —É—Ä–æ–∫—É
                    ];
                    
                    // –î–æ–¥–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–ª–∞—Å—É
                    classes.forEach(() => {
                        row.push('');
                    });
                    
                    data.push(row);
                }
            });

            // –°—Ç–≤–æ—Ä—é—î–º–æ worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
            const colWidths = [
                { wch: 12 },  // –î–µ–Ω—å
                { wch: 8 }    // –£—Ä–æ–∫
            ];
            classes.forEach(() => colWidths.push({ wch: 30 })); // –ö–ª–∞—Å–∏
            ws['!cols'] = colWidths;

            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∏—Å–æ—Ç—É —Ä—è–¥–∫—ñ–≤
            ws['!rows'] = [];
            for (let i = 0; i < data.length; i++) {
                ws['!rows'].push({ hpt: i === 0 ? 20 : 60 }); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—à–∏–π, —Ä–µ—à—Ç–∞ –±—ñ–ª—å—à—ñ
            }

            // –û–±'—î–¥–Ω—É—î–º–æ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –¥–ª—è –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è
            if (!ws['!merges']) ws['!merges'] = [];
            
            let currentRow = 1; // –ü–æ—á–∏–Ω–∞—î–º–æ –∑ 1 (0 - –∑–∞–≥–æ–ª–æ–≤–æ–∫)
            days.forEach(() => {
                ws['!merges'].push({
                    s: { r: currentRow, c: 0 },
                    e: { r: currentRow + lessons - 1, c: 0 }
                });
                currentRow += lessons;
            });

            // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Å—Ç–∏–ª—ñ
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (!ws[cell_ref]) {
                        ws[cell_ref] = { t: 's', v: '' };
                    }
                    
                    ws[cell_ref].s = {
                        alignment: {
                            horizontal: 'center',
                            vertical: 'middle',
                            wrapText: true
                        },
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                    
                    // –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
                    if (R === 0) {
                        ws[cell_ref].s.fill = {
                            patternType: 'solid',
                            fgColor: { rgb: '667eea' }
                        };
                        ws[cell_ref].s.font = {
                            bold: true,
                            color: { rgb: 'FFFFFF' },
                            sz: 12
                        };
                    }
                    // –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–î–µ–Ω—å"
                    else if (C === 0) {
                        ws[cell_ref].s.fill = {
                            patternType: 'solid',
                            fgColor: { rgb: 'e9ecef' }
                        };
                        ws[cell_ref].s.font = {
                            bold: true,
                            sz: 11
                        };
                    }
                    // –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–£—Ä–æ–∫"
                    else if (C === 1) {
                        ws[cell_ref].s.fill = {
                            patternType: 'solid',
                            fgColor: { rgb: 'f8f9fa' }
                        };
                        ws[cell_ref].s.font = {
                            bold: true,
                            sz: 11
                        };
                    }
                }
            }

            // –î–æ–¥–∞—î–º–æ worksheet –¥–æ workbook
            XLSX.utils.book_append_sheet(wb, ws, '–†–æ–∑–∫–ª–∞–¥');

            // –°—Ç–≤–æ—Ä—é—î–º–æ –∞—Ä–∫—É—à –∑ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—î—é —Ç–∞ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏
            const instructionData = [
                ['üìù –Ü–ù–°–¢–†–£–ö–¶–Ü–Ø –î–õ–Ø –ó–ê–ü–û–í–ù–ï–ù–ù–Ø –†–û–ó–ö–õ–ê–î–£'],
                [''],
                ['–§–æ—Ä–º–∞—Ç –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —É—Ä–æ–∫—ñ–≤:'],
                ['–ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É'],
                ['(–Ü–º\'—è –≤—á–∏—Ç–µ–ª—è)'],
                [''],
                ['–ü—Ä–∏–∫–ª–∞–¥ –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —É—Ä–æ–∫—É:'],
                ['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞'],
                ['(–Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.)'],
                [''],
                ['–ü—Ä–∏–∫–ª–∞–¥ –¥–ª—è –ø—ñ–¥–≥—Ä—É–ø (–¥–≤–∞ —É—Ä–æ–∫–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ):'],
                ['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞'],
                ['(–Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.)'],
                ['---'],
                ['–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞'],
                ['(–ü–µ—Ç—Ä–æ–≤–∞ –û.–ú.)'],
                [''],
                ['‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û:'],
                ['‚Ä¢ –ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É —Ç–∞ —ñ–º\'—è –≤—á–∏—Ç–µ–ª—è –º–∞—é—Ç—å –±—É—Ç–∏ –¢–û–ß–ù–û —è–∫ –≤ –∞—Ä–∫—É—à—ñ "–ü—Ä–µ–¥–º–µ—Ç–∏"'],
                ['‚Ä¢ –ú—ñ–∂ –¥–≤–æ–º–∞ —É—Ä–æ–∫–∞–º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ "---" (—Ç—Ä–∏ –¥–µ—Ñ—ñ—Å–∏)'],
                ['‚Ä¢ –ù–µ –∑–º—ñ–Ω—é–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–∑–∫–ª–∞–¥—É'],
                ['‚Ä¢ –ù–µ –≤–∏–¥–∞–ª—è–π—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ "–î–µ–Ω—å" —Ç–∞ "–£—Ä–æ–∫"']
            ];

            const wsInstruction = XLSX.utils.aoa_to_sheet(instructionData);
            wsInstruction['!cols'] = [{ wch: 80 }];

            // –°—Ç–∏–ª—é—î–º–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é
            const instrRange = XLSX.utils.decode_range(wsInstruction['!ref']);
            for (let R = instrRange.s.r; R <= instrRange.e.r; ++R) {
                const cell_ref = XLSX.utils.encode_cell({ c: 0, r: R });
                if (wsInstruction[cell_ref]) {
                    wsInstruction[cell_ref].s = {
                        alignment: { vertical: 'middle', wrapText: true }
                    };
                    
                    if (R === 0) {
                        wsInstruction[cell_ref].s.font = { bold: true, sz: 14 };
                        wsInstruction[cell_ref].s.fill = {
                            patternType: 'solid',
                            fgColor: { rgb: 'fff3cd' }
                        };
                    } else if (wsInstruction[cell_ref].v && wsInstruction[cell_ref].v.includes('‚ö†Ô∏è')) {
                        wsInstruction[cell_ref].s.font = { bold: true };
                    }
                }
            }

            XLSX.utils.book_append_sheet(wb, wsInstruction, '–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è');

            // –Ø–∫—â–æ —î –ø—Ä–µ–¥–º–µ—Ç–∏ - –¥–æ–¥–∞—î–º–æ —ó—Ö —è–∫ –¥–æ–≤—ñ–¥–∫—É
            if (subjects.length > 0) {
                const subjectsData = [['–ü—Ä–µ–¥–º–µ—Ç', '–í—á–∏—Ç–µ–ª—å', '–ì–æ–¥–∏–Ω/—Ç–∏–∂–¥–µ–Ω—å']];
                subjects.forEach(subject => {
                    subjectsData.push([subject.name, subject.teacher, subject.hours]);
                });

                const wsSubjects = XLSX.utils.aoa_to_sheet(subjectsData);
                wsSubjects['!cols'] = [{ wch: 30 }, { wch: 25 }, { wch: 15 }];

                // –°—Ç–∏–ª—é—î–º–æ –∞—Ä–∫—É—à –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                const subjRange = XLSX.utils.decode_range(wsSubjects['!ref']);
                for (let R = subjRange.s.r; R <= subjRange.e.r; ++R) {
                    for (let C = subjRange.s.c; C <= subjRange.e.c; ++C) {
                        const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                        if (!wsSubjects[cell_ref]) wsSubjects[cell_ref] = { t: 's', v: '' };
                        
                        wsSubjects[cell_ref].s = {
                            alignment: { horizontal: 'center', vertical: 'middle' },
                            border: {
                                top: { style: 'thin' },
                                bottom: { style: 'thin' },
                                left: { style: 'thin' },
                                right: { style: 'thin' }
                            }
                        };
                        
                        if (R === 0) {
                            wsSubjects[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: '667eea' }
                            };
                            wsSubjects[cell_ref].s.font = {
                                bold: true,
                                color: { rgb: 'FFFFFF' }
                            };
                        }
                    }
                }

                XLSX.utils.book_append_sheet(wb, wsSubjects, '–ü—Ä–µ–¥–º–µ—Ç–∏');
            }

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
            XLSX.writeFile(wb, 'Shablon_Rozklad.xlsx');

            alert('‚úÖ –®–∞–±–ª–æ–Ω —Ä–æ–∑–∫–ª–∞–¥—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!\n\n' +
                  'üìã –£ —Ñ–∞–π–ª—ñ 3 –∞—Ä–∫—É—à—ñ:\n' +
                  '1. –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è - —è–∫ –∑–∞–ø–æ–≤–Ω—é–≤–∞—Ç–∏\n' +
                  '2. –†–æ–∑–∫–ª–∞–¥ - –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–æ–∑–∫–ª–∞–¥ –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è\n' +
                  '3. –ü—Ä–µ–¥–º–µ—Ç–∏ - —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤\n\n' +
                  'üìù –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ä–æ–∑–∫–ª–∞–¥ –∑–≥—ñ–¥–Ω–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —Ç–∞ —ñ–º–ø–æ—Ä—Ç—É–π—Ç–µ –Ω–∞–∑–∞–¥!');
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ localStorage –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É
        loadFromLocalStorage();

        renderClasses();
        renderSubjects();
        renderSchedules();
        updateTeachersList();
    </script>
</body>
</html>
