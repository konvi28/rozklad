<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/webp" href="logo.webp">
    <link rel="shortcut icon" type="image/webp" href="logo.webp">
    <link rel="apple-touch-icon" href="logo.webp">
    <title>–†–æ–∑–∫–ª–∞–¥ —É—Ä–æ–∫—ñ–≤ v 1.93</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .container {
            max-width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9em;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0;
        }

        .tab {
            flex: 1;
            padding: 12px 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 14px;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-hour-control {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .btn-hour-control:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .btn-hour-control:active {
            transform: scale(0.95);
        }

        .btn-success {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            font-size: 13px;
            margin-right: 5px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            padding: 8px 15px;
            font-size: 13px;
        }

        .btn-info:hover {
            background: #138496;
        }

        .save-load-section {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .save-load-section h3 {
            width: 100%;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        .class-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .class-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        .class-card h3 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .class-card-actions {
            margin-top: 15px;
        }

        .subject-list {
            margin-top: 30px;
        }

        .subject-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .subject-info {
            flex: 1;
        }

        .subject-name {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }

        .subject-teacher {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        .subject-hours {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-right: 10px;
        }

        .tiles-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            min-height: 50px;
        }

        .tiles-container.drag-over {
            background: #e7f3ff;
            border: 2px dashed #667eea;
        }

        .lesson-tile {
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: move;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .lesson-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .lesson-tile.dragging {
            opacity: 0.5;
        }

        .lesson-tile.used {
            background: #6c757d !important;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .schedule-wrapper {
            overflow: auto;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1;
            min-height: 0;
        }
        
        .schedule-wrapper::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .schedule-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .schedule-wrapper::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .schedule-wrapper::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            background: white;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #000000;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
        }
        
        .schedule-table th:first-child {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }
        
        .schedule-table th:first-child,
        .schedule-table th:nth-child(2) {
            position: sticky;
            left: 0;
            z-index: 11;
        }
        
        .schedule-table th:nth-child(2) {
            left: auto;
        }

        .schedule-table td {
            padding: 5px;
            border: 1px solid #000000;
            text-align: center;
            vertical-align: middle;
            min-height: 60px;
        }
        
        .schedule-table td:first-child {
            position: sticky;
            left: 0;
            background: #e9ecef;
            z-index: 5;
            font-weight: 600;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }
        
        .schedule-table td.lesson-number {
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .lesson-number {
            font-weight: 600;
            background: #f8f9fa;
            color: #667eea;
        }

        .lesson-slot {
            min-height: 60px;
            background: #f8f9fa;
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            font-size: 12px;
            transition: all 0.3s;
        }

        .lesson-slot:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .lesson-slot.drag-over {
            background: #e7f3ff;
            border-color: #667eea;
            border-style: solid;
        }

        .lesson-card {
            padding: 6px 8px;
            border-radius: 8px;
            color: white;
            cursor: move;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            user-select: none;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .lesson-card.drag-over {
            box-shadow: 0 0 0 3px #667eea;
        }

        .multiple-lessons.drag-over {
            box-shadow: 0 0 0 3px #667eea;
        }

        .schedule-table td.drag-over {
            background: #e7f3ff !important;
        }

        .lesson-card.dragging {
            opacity: 0.5;
        }

        .lesson-card-subject {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .lesson-card-teacher {
            font-size: 10px;
            opacity: 0.9;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .delete-lesson-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 255, 255, 0.9);
            color: #dc3545;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .delete-lesson-btn:hover {
            background: #dc3545;
            color: white;
            opacity: 1;
            transform: scale(1.1);
        }

        .lesson-card:hover .delete-lesson-btn {
            opacity: 1;
        }

        .multiple-lessons {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .lesson-card-split {
            padding: 6px 8px;
            font-size: 12px;
        }

        .lesson-card-split .lesson-card-subject {
            font-size: 12px;
            margin-bottom: 2px;
        }

        .lesson-card-split .lesson-card-teacher {
            font-size: 10px;
        }

        .lesson-card-split .delete-lesson-btn {
            width: 18px;
            height: 18px;
            font-size: 14px;
        }

        .available-tiles-section {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .available-tiles-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .available-tiles-section::-webkit-scrollbar-track {
            background: #e9ecef;
            border-radius: 10px;
        }
        
        .available-tiles-section::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .available-tiles-section::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .available-tiles-section h2 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .available-tiles-section .subject-item {
            margin-bottom: 6px;
            padding: 6px;
        }
        
        .available-tiles-section .subject-name {
            font-size: 13px;
        }
        
        .available-tiles-section .subject-teacher {
            font-size: 11px;
        }
        
        .available-tiles-section .tiles-container {
            padding: 5px;
            min-height: 35px;
        }

        .schedules-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .class-schedule-section {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .class-schedule-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #495057;
        }

        .footer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö –†–æ–∑–∫–ª–∞–¥ —É—Ä–æ–∫—ñ–≤</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥–æ–º</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('classes')">–ö–ª–∞—Å–∏</button>
            <button class="tab" onclick="switchTab('subjects')">–ü—Ä–µ–¥–º–µ—Ç–∏ —ñ –≤—á–∏—Ç–µ–ª—ñ</button>
            <button class="tab" onclick="switchTab('schedule')">–†–æ–∑–∫–ª–∞–¥</button>
        </div>

        <div id="classesTab" class="tab-content active">
            <h2>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –∫–ª–∞—Å</h2>
            <div class="form-group">
                <label for="className">–ù–∞–∑–≤–∞ –∫–ª–∞—Å—É:</label>
                <input type="text" id="className" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 5-–ê">
            </div>
            <button class="btn btn-primary" onclick="addClass()">–î–æ–¥–∞—Ç–∏ –∫–ª–∞—Å</button>
            
            <h2 style="margin-top: 40px;">–°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—ñ–≤</h2>
            <div id="classList" class="class-list"></div>
        </div>

        <div id="subjectsTab" class="tab-content">
            <h2>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ø—Ä–µ–¥–º–µ—Ç</h2>
            <div class="form-group">
                <label for="subjectName">–ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É:</label>
                <input type="text" id="subjectName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">
            </div>
            <div class="form-group">
                <label for="teacherName">–Ü–º'—è –≤—á–∏—Ç–µ–ª—è:</label>
                <input type="text" id="teacherName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.">
            </div>
            <div class="form-group">
                <label for="hoursPerWeek">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å:</label>
                <input type="number" id="hoursPerWeek" min="1" max="20" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 5">
            </div>
            <button class="btn btn-primary" onclick="addSubject()">–î–æ–¥–∞—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç</button>
            
            <div id="subjectsStats" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div>
                        <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ñ–≤:</strong> <span id="totalSubjects">0</span>
                    </div>
                    <div>
                        <strong>–£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤:</strong> <span id="totalTeachers">0</span>
                    </div>
                    <div>
                        <strong>–°—É–º–∞—Ä–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω:</strong> <span id="totalHours">0</span>
                    </div>
                </div>
            </div>
            
            <div id="subjectList" class="subject-list"></div>
        </div>

        <div id="scheduleTab" class="tab-content">
            <div class="save-load-section">
                <h3>üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
                <button class="btn btn-success" onclick="saveData()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥ (JSON)</button>
                <button class="btn btn-info" onclick="document.getElementById('fileInput').click()">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥ (JSON)</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                <button class="btn btn-danger" onclick="clearDemoData()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ</button>
                <button class="btn btn-info" onclick="checkTeacherConflicts()">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑–±—ñ–≥</button>
                <input type="file" id="fileInput" accept=".json" onchange="loadData(event)">
            </div>
            <div id="scheduleContent"></div>
        </div>

        <div class="footer">
            –†–æ–∑—Ä–æ–±–Ω–∏–∫ Obariv by Krasovskiy
        </div>
    </div>

    <script>
        const days = ['–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', '–ü\'—è—Ç–Ω–∏—Ü—è'];
        const lessons = 7;
        
        let classes = [
            { id: 1, name: '5-–ê' },
            { id: 2, name: '6-–ë' },
            { id: 3, name: '7-–í' }
        ];
        
        let subjects = [
            { id: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.', hours: 5 },
            { id: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.', hours: 4 },
            { id: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.', hours: 3 },
            { id: 4, name: '–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏', teacher: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –í.–°.', hours: 2 },
            { id: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.', hours: 3 },
            { id: 6, name: '–ë—ñ–æ–ª–æ–≥—ñ—è', teacher: '–ú–µ–ª—å–Ω–∏–∫ –¢.–ê.', hours: 2 },
            { id: 7, name: '–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è', teacher: '–ë–æ–π–∫–æ –ù.–í.', hours: 2 },
            { id: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.', hours: 3 }
        ];
        
        let schedules = {
            1: {
                '0-0': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '0-1': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' },
                '0-2': { subjectId: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.' },
                '1-0': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '1-1': { subjectId: 4, name: '–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏', teacher: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –í.–°.' },
                '1-2': { subjectId: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.' },
                '2-0': { subjectId: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.' },
                '2-1': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '2-2': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' }
            },
            2: {
                '0-0': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' },
                '0-1': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '0-2': { subjectId: 6, name: '–ë—ñ–æ–ª–æ–≥—ñ—è', teacher: '–ú–µ–ª—å–Ω–∏–∫ –¢.–ê.' },
                '1-0': { subjectId: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.' },
                '1-1': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '1-2': { subjectId: 7, name: '–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è', teacher: '–ë–æ–π–∫–æ –ù.–í.' },
                '2-0': { subjectId: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.' },
                '2-1': { subjectId: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.' },
                '2-2': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' }
            },
            3: {
                '0-0': { subjectId: 5, name: '–§—ñ–∑–∏–∫–∞', teacher: '–®–µ–≤—á–µ–Ω–∫–æ –î.–ú.' },
                '0-1': { subjectId: 3, name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –õ.–í.' },
                '0-2': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '1-0': { subjectId: 2, name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ú.–Ü.' },
                '1-1': { subjectId: 6, name: '–ë—ñ–æ–ª–æ–≥—ñ—è', teacher: '–ú–µ–ª—å–Ω–∏–∫ –¢.–ê.' },
                '1-2': { subjectId: 4, name: '–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏', teacher: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –í.–°.' },
                '2-0': { subjectId: 1, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', teacher: '–Ü–≤–∞–Ω–µ–Ω–∫–æ –û.–ü.' },
                '2-1': { subjectId: 8, name: '–§—ñ–∑–∫—É–ª—å—Ç—É—Ä–∞', teacher: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –Ü.–û.' },
                '2-2': { subjectId: 7, name: '–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è', teacher: '–ë–æ–π–∫–æ –ù.–í.' }
            }
        };
        
        let nextClassId = 4;
        let nextSubjectId = 9;

        const subjectColors = [
            '#667eea', '#f093fb', '#4facfe', '#43e97b',
            '#fa709a', '#fee140', '#30cfd0', '#a8edea',
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'
        ];

        function getSubjectColor(subjectId) {
            return subjectColors[(subjectId - 1) % subjectColors.length];
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function addClass() {
            const name = document.getElementById('className').value.trim();
            
            if (!name) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∫–ª–∞—Å—É');
                return;
            }

            const newClass = {
                id: nextClassId++,
                name: name
            };

            classes.push(newClass);
            schedules[newClass.id] = {};
            
            document.getElementById('className').value = '';
            renderClasses();
            renderSchedules();
        }

        function removeClass(id) {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–ª–∞—Å?')) {
                classes = classes.filter(c => c.id !== id);
                delete schedules[id];
                renderClasses();
                renderSchedules();
            }
        }

        function addSubject() {
            const name = document.getElementById('subjectName').value.trim();
            const teacher = document.getElementById('teacherName').value.trim();
            const hours = parseInt(document.getElementById('hoursPerWeek').value);

            if (!name || !teacher || !hours) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
                return;
            }

            const newSubject = {
                id: nextSubjectId++,
                name: name,
                teacher: teacher,
                hours: hours
            };

            subjects.push(newSubject);
            
            document.getElementById('subjectName').value = '';
            document.getElementById('teacherName').value = '';
            document.getElementById('hoursPerWeek').value = '';
            
            renderSubjects();
            renderSchedules();
        }

        function removeSubject(id) {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø—Ä–µ–¥–º–µ—Ç?')) {
                subjects = subjects.filter(s => s.id !== id);
                
                Object.keys(schedules).forEach(classId => {
                    Object.keys(schedules[classId]).forEach(key => {
                        if (schedules[classId][key].subjectId === id) {
                            delete schedules[classId][key];
                        }
                    });
                });
                
                renderSubjects();
                renderSchedules();
            }
        }

        function renderClasses() {
            const list = document.getElementById('classList');
            
            if (classes.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">–ù–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤</p>';
                return;
            }

            list.innerHTML = classes.map(cls => `
                <div class="class-card">
                    <h3>${cls.name}</h3>
                    <div class="class-card-actions">
                        <button class="btn btn-danger" onclick="removeClass(${cls.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </div>
                </div>
            `).join('');
        }

        function renderSubjects() {
            const list = document.getElementById('subjectList');
            const statsDiv = document.getElementById('subjectsStats');
            
            if (subjects.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">–ù–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</p>';
                statsDiv.style.display = 'none';
                return;
            }

            // –ü–æ–∫–∞–∑—É—î–º–æ —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            statsDiv.style.display = 'block';
            
            // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—á–∏—Ç–µ–ª—ñ–≤
            const uniqueTeachers = new Set(subjects.map(s => s.teacher)).size;
            
            // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ —Å—É–º–∞—Ä–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω
            const totalHours = subjects.reduce((sum, s) => sum + s.hours, 0);
            
            document.getElementById('totalSubjects').textContent = subjects.length;
            document.getElementById('totalTeachers').textContent = uniqueTeachers;
            document.getElementById('totalHours').textContent = totalHours;

            list.innerHTML = subjects.map(subject => {
                let usedCount = 0;
                classes.forEach(cls => {
                    const schedule = schedules[cls.id] || {};
                    Object.values(schedule).forEach(slot => {
                        if (Array.isArray(slot)) {
                            usedCount += slot.filter(s => s.subjectId === subject.id).length;
                        } else if (slot && slot.subjectId === subject.id) {
                            usedCount++;
                        }
                    });
                });

                const color = getSubjectColor(subject.id);
                const tiles = [];
                
                for (let i = 0; i < subject.hours; i++) {
                    const isUsed = i < usedCount;
                    tiles.push(`
                        <div class="lesson-tile ${isUsed ? 'used' : ''}" 
                             draggable="${!isUsed}"
                             data-subject-id="${subject.id}"
                             data-tile-index="${i}"
                             style="background: ${color};">
                            ${subject.name}
                        </div>
                    `);
                }
                
                return `
                    <div class="subject-item">
                        <div class="subject-header">
                            <div class="subject-info">
                                <div class="subject-name">${subject.name}</div>
                                <div class="subject-teacher">–í—á–∏—Ç–µ–ª—å: ${subject.teacher}</div>
                            </div>
                            <span class="subject-hours">${usedCount}/${subject.hours} –≥–æ–¥</span>
                            <button class="btn btn-danger" onclick="removeSubject(${subject.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                        <div class="tiles-container" 
                             data-subject-id="${subject.id}">
                            ${tiles.join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
            attachTileDragHandlers();
        }

        function renderSchedules() {
            const content = document.getElementById('scheduleContent');
            
            if (classes.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –∫–ª–∞—Å–∏</h3>
                        <p>–ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ö–ª–∞—Å–∏" —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –∫–ª–∞—Å–∏</p>
                    </div>
                `;
                return;
            }

            if (subjects.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç–∏</h3>
                        <p>–ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ü—Ä–µ–¥–º–µ—Ç–∏ —ñ –≤—á–∏—Ç–µ–ª—ñ" —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç–∏</p>
                    </div>
                `;
                return;
            }

            // –ì–µ–Ω–µ—Ä—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –ø–ª–∏—Ç–æ—á–∫–∏
            let tilesHtml = '<div class="available-tiles-section"><h2>–î–æ—Å—Ç—É–ø–Ω—ñ —É—Ä–æ–∫–∏ –¥–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è</h2>';
            
            subjects.forEach(subject => {
                let usedCount = 0;
                classes.forEach(cls => {
                    const schedule = schedules[cls.id] || {};
                    Object.values(schedule).forEach(slot => {
                        if (Array.isArray(slot)) {
                            usedCount += slot.filter(s => s.subjectId === subject.id).length;
                        } else if (slot && slot.subjectId === subject.id) {
                            usedCount++;
                        }
                    });
                });
                
                const availableCount = subject.hours - usedCount;
                const color = getSubjectColor(subject.id);
                
                tilesHtml += `
                    <div class="subject-item" style="margin-bottom: 15px;">
                        <div class="subject-header">
                            <div class="subject-info">
                                <div class="subject-name">${subject.name}</div>
                                <div class="subject-teacher">–í—á–∏—Ç–µ–ª—å: ${subject.teacher} ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: ${availableCount} –∑ ${subject.hours}</div>
                            </div>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <button class="btn-hour-control" onclick="changeSubjectHours(${subject.id}, -1); event.stopPropagation();" title="–ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">‚àí</button>
                                <button class="btn-hour-control" onclick="changeSubjectHours(${subject.id}, 1); event.stopPropagation();" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω">+</button>
                            </div>
                        </div>
                        <div class="tiles-container" data-subject-id="${subject.id}">
                `;
                
                for (let i = 0; i < availableCount; i++) {
                    tilesHtml += `
                        <div class="lesson-tile" 
                             draggable="true"
                             data-subject-id="${subject.id}"
                             style="background: ${color};">
                            ${subject.name}
                        </div>
                    `;
                }
                
                if (availableCount === 0) {
                    tilesHtml += `<div style="color: #6c757d; font-size: 12px; padding: 5px;">–í—Å—ñ —É—Ä–æ–∫–∏ —Ä–æ–∑–º—ñ—â–µ–Ω—ñ –≤ —Ä–æ–∑–∫–ª–∞–¥—ñ</div>`;
                }
                
                tilesHtml += '</div></div>';
            });
            
            tilesHtml += '</div>';

            // –ì–µ–Ω–µ—Ä—É—î–º–æ —Ä–æ–∑–∫–ª–∞–¥
            let schedulesHtml = '<div class="schedules-container">';
            
            schedulesHtml += `
                <div class="class-schedule-section">
                    <div class="class-schedule-title">–†–æ–∑–∫–ª–∞–¥ —É—Ä–æ–∫—ñ–≤</div>
                    <div class="schedule-wrapper">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>–î–µ–Ω—å</th>
                                    <th>–£—Ä–æ–∫</th>
                                    ${classes.map(cls => `<th>${cls.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
            `;

            days.forEach((day, dayIndex) => {
                for (let i = 1; i <= lessons; i++) {
                    schedulesHtml += `<tr>`;
                    
                    if (i === 1) {
                        schedulesHtml += `<td rowspan="${lessons}" style="font-weight: 600; background: #e9ecef; vertical-align: middle;">${day}</td>`;
                    }
                    
                    schedulesHtml += `<td class="lesson-number">${i}</td>`;
                    
                    classes.forEach(cls => {
                        const key = `${dayIndex}-${i-1}`;
                        const lesson = schedules[cls.id][key];
                        
                        schedulesHtml += `<td>`;
                        
                        if (lesson) {
                            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –º–∞—Å–∏–≤ —É—Ä–æ–∫—ñ–≤ (–ø—ñ–¥–≥—Ä—É–ø–∏)
                            if (Array.isArray(lesson)) {
                                schedulesHtml += `<div class="multiple-lessons">`;
                                lesson.forEach((les, idx) => {
                                    const color = getSubjectColor(les.subjectId);
                                    schedulesHtml += `
                                        <div class="lesson-card lesson-card-split" draggable="true" 
                                             data-subject-id="${les.subjectId}"
                                             data-from-schedule="true"
                                             data-class-id="${cls.id}"
                                             data-day="${dayIndex}"
                                             data-lesson="${i-1}"
                                             style="background: ${color}; position: relative; margin-bottom: ${idx < lesson.length - 1 ? '4px' : '0'};">
                                            <button class="delete-lesson-btn" onclick="deleteLesson(${cls.id}, ${dayIndex}, ${i-1}, ${les.subjectId}); event.stopPropagation();" title="–í–∏–¥–∞–ª–∏—Ç–∏ —É—Ä–æ–∫">√ó</button>
                                            <div class="lesson-card-subject">${les.name}</div>
                                            <div class="lesson-card-teacher">${les.teacher}</div>
                                        </div>
                                    `;
                                });
                                schedulesHtml += `</div>`;
                            } else {
                                // –û–¥–∏–Ω —É—Ä–æ–∫
                                const color = getSubjectColor(lesson.subjectId);
                                schedulesHtml += `
                                    <div class="lesson-card" draggable="true" 
                                         data-subject-id="${lesson.subjectId}"
                                         data-from-schedule="true"
                                         data-class-id="${cls.id}"
                                         data-day="${dayIndex}"
                                         data-lesson="${i-1}"
                                         style="background: ${color}; position: relative;">
                                        <button class="delete-lesson-btn" onclick="deleteLesson(${cls.id}, ${dayIndex}, ${i-1}); event.stopPropagation();" title="–í–∏–¥–∞–ª–∏—Ç–∏ —É—Ä–æ–∫">√ó</button>
                                        <div class="lesson-card-subject">${lesson.name}</div>
                                        <div class="lesson-card-teacher">${lesson.teacher}</div>
                                    </div>
                                `;
                            }
                        } else {
                            schedulesHtml += `
                                <div class="lesson-slot" 
                                     data-class-id="${cls.id}"
                                     data-day="${dayIndex}" 
                                     data-lesson="${i-1}">
                                </div>
                            `;
                        }
                        
                        schedulesHtml += `</td>`;
                    });
                    
                    schedulesHtml += '</tr>';
                }
            });

            schedulesHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            schedulesHtml += '</div>';
            content.innerHTML = tilesHtml + schedulesHtml;
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏
            attachScheduleDragHandlers();
        }

        let draggedElement = null;
        let draggedSubjectId = null;
        let fromSchedule = false;
        let originalSlot = null;

        function attachTileDragHandlers() {
            const tiles = document.querySelectorAll('.lesson-tile[draggable="true"]');
            tiles.forEach(tile => {
                tile.addEventListener('dragstart', handleTileDragStart);
                tile.addEventListener('dragend', handleDragEnd);
            });

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –ø–ª–∏—Ç–æ–∫
            const containers = document.querySelectorAll('.tiles-container');
            containers.forEach(container => {
                container.addEventListener('dragover', handleContainerDragOver);
                container.addEventListener('dragleave', handleContainerDragLeave);
                container.addEventListener('drop', handleContainerDrop);
            });
        }

        function attachScheduleDragHandlers() {
            const tiles = document.querySelectorAll('.lesson-tile[draggable="true"]');
            tiles.forEach(tile => {
                tile.addEventListener('dragstart', handleTileDragStart);
                tile.addEventListener('dragend', handleDragEnd);
            });

            const cards = document.querySelectorAll('.lesson-card[draggable="true"]');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleCardDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            const slots = document.querySelectorAll('.lesson-slot');
            slots.forEach(slot => {
                slot.addEventListener('dragover', handleSlotDragOver);
                slot.addEventListener('dragleave', handleSlotDragLeave);
                slot.addEventListener('drop', handleSlotDrop);
            });

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–æ –≤—Å—ñ—Ö td –≤ —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–∑–∫–ª–∞–¥—É (–∫—Ä—ñ–º –ø–µ—Ä—à–∏—Ö –¥–≤–æ—Ö –∫–æ–ª–æ–Ω–æ–∫)
            const scheduleTds = document.querySelectorAll('.schedule-table tbody td:not(.lesson-number):not(:first-child)');
            scheduleTds.forEach(td => {
                // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ td –∑ lesson-slot (–≤–æ–Ω–∏ –≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω—ñ)
                if (td.querySelector('.lesson-slot')) return;
                
                td.addEventListener('dragover', handleTdDragOver);
                td.addEventListener('dragleave', handleTdDragLeave);
                td.addEventListener('drop', handleTdDrop);
            });

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –ø–ª–∏—Ç–æ–∫
            const containers = document.querySelectorAll('.tiles-container');
            containers.forEach(container => {
                container.addEventListener('dragover', handleContainerDragOver);
                container.addEventListener('dragleave', handleContainerDragLeave);
                container.addEventListener('drop', handleContainerDrop);
            });
        }

        function handleTileDragStart(e) {
            draggedElement = e.target;
            draggedSubjectId = parseInt(e.target.dataset.subjectId);
            fromSchedule = false;
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleCardDragStart(e) {
            draggedElement = e.target;
            draggedSubjectId = parseInt(e.target.dataset.subjectId);
            fromSchedule = true;
            
            originalSlot = {
                classId: parseInt(e.target.dataset.classId),
                day: e.target.dataset.day,
                lesson: e.target.dataset.lesson
            };
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleSlotDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
        }

        function handleSlotDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleTdDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const lessonCard = e.currentTarget.querySelector('.lesson-card, .multiple-lessons');
            if (lessonCard) {
                lessonCard.classList.add('drag-over');
            }
            e.dataTransfer.dropEffect = 'move';
        }

        function handleTdDragLeave(e) {
            e.stopPropagation();
            const lessonCard = e.currentTarget.querySelector('.lesson-card, .multiple-lessons');
            if (lessonCard) {
                lessonCard.classList.remove('drag-over');
            }
        }

        function handleTdDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const td = e.currentTarget;
            const lessonCard = td.querySelector('.lesson-card, .multiple-lessons');
            if (lessonCard) {
                lessonCard.classList.remove('drag-over');
            }
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –ø–µ—Ä—à–æ–≥–æ lesson-card –≤ td
            const firstCard = td.querySelector('.lesson-card');
            if (!firstCard) return;
            
            const classId = parseInt(firstCard.dataset.classId);
            const day = firstCard.dataset.day;
            const lesson = firstCard.dataset.lesson;
            const key = `${day}-${lesson}`;
            
            const schedule = schedules[classId];
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            const scrollTop = scheduleWrapper ? scheduleWrapper.scrollTop : 0;
            const scrollLeft = scheduleWrapper ? scheduleWrapper.scrollLeft : 0;
            
            // –Ø–∫—â–æ –ø–µ—Ä–µ–º—ñ—â—É—î–º–æ –∑ —Ä–æ–∑–∫–ª–∞–¥—É
            if (fromSchedule && originalSlot) {
                const oldKey = `${originalSlot.day}-${originalSlot.lesson}`;
                const oldLessons = schedules[originalSlot.classId][oldKey];
                
                if (Array.isArray(oldLessons)) {
                    // –í–∏–¥–∞–ª—è—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —É—Ä–æ–∫ –∑ –º–∞—Å–∏–≤—É
                    schedules[originalSlot.classId][oldKey] = oldLessons.filter(l => l.subjectId !== draggedSubjectId);
                    if (schedules[originalSlot.classId][oldKey].length === 0) {
                        delete schedules[originalSlot.classId][oldKey];
                    }
                } else if (oldLessons && oldLessons.subjectId === draggedSubjectId) {
                    delete schedules[originalSlot.classId][oldKey];
                }
            }
            
            // –î–æ–¥–∞—î–º–æ —É—Ä–æ–∫ –¥–æ –Ω–æ–≤–æ–≥–æ —Å–ª–æ—Ç—É
            const subject = subjects.find(s => s.id === draggedSubjectId);
            const newLesson = {
                subjectId: subject.id,
                name: subject.name,
                teacher: subject.teacher
            };
            
            // –Ø–∫—â–æ –≤ —Å–ª–æ—Ç—ñ –≤–∂–µ —î —É—Ä–æ–∫(–∏), –¥–æ–¥–∞—î–º–æ –¥–æ –º–∞—Å–∏–≤—É
            if (schedule[key]) {
                if (Array.isArray(schedule[key])) {
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ç–∞–∫–∏–π —É—Ä–æ–∫ –≤–∂–µ –Ω–µ –¥–æ–¥–∞–Ω–∏–π
                    const exists = schedule[key].some(l => l.subjectId === subject.id);
                    if (!exists) {
                        schedule[key].push(newLesson);
                    }
                } else {
                    // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –≤ –º–∞—Å–∏–≤
                    const existingLesson = schedule[key];
                    if (existingLesson.subjectId !== subject.id) {
                        schedule[key] = [existingLesson, newLesson];
                    }
                }
            } else {
                schedule[key] = newLesson;
            }
            
            renderSchedules();
            renderSubjects();
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
            setTimeout(() => {
                const newScheduleWrapper = document.querySelector('.schedule-wrapper');
                if (newScheduleWrapper) {
                    newScheduleWrapper.scrollTop = scrollTop;
                    newScheduleWrapper.scrollLeft = scrollLeft;
                }
            }, 0);
        }

        function handleSlotDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const slot = e.currentTarget;
            const classId = parseInt(slot.dataset.classId);
            const day = slot.dataset.day;
            const lesson = slot.dataset.lesson;
            const key = `${day}-${lesson}`;
            
            const schedule = schedules[classId];
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            const scrollTop = scheduleWrapper ? scheduleWrapper.scrollTop : 0;
            const scrollLeft = scheduleWrapper ? scheduleWrapper.scrollLeft : 0;
            
            // –Ø–∫—â–æ –ø–µ—Ä–µ–º—ñ—â—É—î–º–æ –∑ —Ä–æ–∑–∫–ª–∞–¥—É
            if (fromSchedule && originalSlot) {
                const oldKey = `${originalSlot.day}-${originalSlot.lesson}`;
                const oldLessons = schedules[originalSlot.classId][oldKey];
                
                if (Array.isArray(oldLessons)) {
                    // –í–∏–¥–∞–ª—è—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —É—Ä–æ–∫ –∑ –º–∞—Å–∏–≤—É
                    schedules[originalSlot.classId][oldKey] = oldLessons.filter(l => l.subjectId !== draggedSubjectId);
                    if (schedules[originalSlot.classId][oldKey].length === 0) {
                        delete schedules[originalSlot.classId][oldKey];
                    }
                } else if (oldLessons && oldLessons.subjectId === draggedSubjectId) {
                    delete schedules[originalSlot.classId][oldKey];
                }
            }
            
            // –î–æ–¥–∞—î–º–æ —É—Ä–æ–∫ –¥–æ –Ω–æ–≤–æ–≥–æ —Å–ª–æ—Ç—É
            const subject = subjects.find(s => s.id === draggedSubjectId);
            const newLesson = {
                subjectId: subject.id,
                name: subject.name,
                teacher: subject.teacher
            };
            
            // –Ø–∫—â–æ –≤ —Å–ª–æ—Ç—ñ –≤–∂–µ —î —É—Ä–æ–∫(–∏), –¥–æ–¥–∞—î–º–æ –¥–æ –º–∞—Å–∏–≤—É
            if (schedule[key]) {
                if (Array.isArray(schedule[key])) {
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ç–∞–∫–∏–π —É—Ä–æ–∫ –≤–∂–µ –Ω–µ –¥–æ–¥–∞–Ω–∏–π
                    const exists = schedule[key].some(l => l.subjectId === subject.id);
                    if (!exists) {
                        schedule[key].push(newLesson);
                    }
                } else {
                    // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –≤ –º–∞—Å–∏–≤
                    const existingLesson = schedule[key];
                    if (existingLesson.subjectId !== subject.id) {
                        schedule[key] = [existingLesson, newLesson];
                    }
                }
            } else {
                schedule[key] = newLesson;
            }
            
            renderSchedules();
            renderSubjects();
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
            setTimeout(() => {
                const newScheduleWrapper = document.querySelector('.schedule-wrapper');
                if (newScheduleWrapper) {
                    newScheduleWrapper.scrollTop = scrollTop;
                    newScheduleWrapper.scrollLeft = scrollLeft;
                }
            }, 0);
        }

        function handleContainerDragOver(e) {
            // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
            e.dataTransfer.dropEffect = 'none';
        }

        function handleContainerDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleContainerDrop(e) {
            // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ drop –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
            e.preventDefault();
            return false;
        }

        // –§—É–Ω–∫—Ü—ñ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        function changeSubjectHours(subjectId, change) {
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            const newHours = subject.hours + change;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å
            if (newHours < 1) {
                alert('‚ö†Ô∏è –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –º–µ–Ω—à–µ 1');
                return;
            }
            
            // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ —Å–∫—ñ–ª—å–∫–∏ –≥–æ–¥–∏–Ω –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ
            let usedCount = 0;
            classes.forEach(cls => {
                const schedule = schedules[cls.id] || {};
                Object.values(schedule).forEach(slot => {
                    if (Array.isArray(slot)) {
                        usedCount += slot.filter(s => s.subjectId === subject.id).length;
                    } else if (slot && slot.subjectId === subject.id) {
                        usedCount++;
                    }
                });
            });
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –Ω–æ–≤–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–µ –º–µ–Ω—à–∞ –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—É (—Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –∑–º–µ–Ω—à–µ–Ω–Ω—ñ)
            if (change < 0 && newHours < usedCount) {
                alert(`‚ö†Ô∏è –ù–µ–º–æ–∂–ª–∏–≤–æ –∑–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω –¥–æ ${newHours}, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ ${usedCount} –≥–æ–¥–∏–Ω –≤ —Ä–æ–∑–∫–ª–∞–¥—ñ. –°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª—ñ—Ç—å –¥–µ—è–∫—ñ —É—Ä–æ–∫–∏ –∑ —Ä–æ–∑–∫–ª–∞–¥—É.`);
                return;
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω
            subject.hours = newHours;
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            const scheduleWrapper = document.querySelector('.schedule-wrapper');
            const scrollTop = scheduleWrapper ? scheduleWrapper.scrollTop : 0;
            const scrollLeft = scheduleWrapper ? scheduleWrapper.scrollLeft : 0;
            
            renderSubjects();
            renderSchedules();
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            setTimeout(() => {
                const newScheduleWrapper = document.querySelector('.schedule-wrapper');
                if (newScheduleWrapper) {
                    newScheduleWrapper.scrollTop = scrollTop;
                    newScheduleWrapper.scrollLeft = scrollLeft;
                }
            }, 0);
        }

        function clearDemoData() {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ (–∫–ª–∞—Å–∏, –ø—Ä–µ–¥–º–µ—Ç–∏, —Ä–æ–∑–∫–ª–∞–¥)?')) {
                classes = [];
                subjects = [];
                schedules = {};
                nextClassId = 1;
                nextSubjectId = 1;
                
                renderClasses();
                renderSubjects();
                renderSchedules();
                
                alert('‚úÖ –í—Å—ñ –¥–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ!');
            }
        }

        function deleteLesson(classId, day, lesson, subjectId = null) {
            const key = `${day}-${lesson}`;
            
            if (schedules[classId] && schedules[classId][key]) {
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const scheduleWrapper = document.querySelector('.schedule-wrapper');
                const scrollTop = scheduleWrapper ? scheduleWrapper.scrollTop : 0;
                const scrollLeft = scheduleWrapper ? scheduleWrapper.scrollLeft : 0;
                
                const slot = schedules[classId][key];
                
                // –Ø–∫—â–æ —Ü–µ –º–∞—Å–∏–≤ —É—Ä–æ–∫—ñ–≤ —ñ –≤–∫–∞–∑–∞–Ω–æ subjectId
                if (Array.isArray(slot) && subjectId !== null) {
                    schedules[classId][key] = slot.filter(l => l.subjectId !== subjectId);
                    if (schedules[classId][key].length === 0) {
                        delete schedules[classId][key];
                    }
                } else {
                    // –í–∏–¥–∞–ª—è—î–º–æ –≤–µ—Å—å —Å–ª–æ—Ç
                    delete schedules[classId][key];
                }
                
                renderSchedules();
                renderSubjects();
                
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
                setTimeout(() => {
                    const newScheduleWrapper = document.querySelector('.schedule-wrapper');
                    if (newScheduleWrapper) {
                        newScheduleWrapper.scrollTop = scrollTop;
                        newScheduleWrapper.scrollLeft = scrollLeft;
                    }
                }, 0);
            }
        }

        function saveData() {
            const data = {
                classes: classes,
                subjects: subjects,
                schedules: schedules,
                nextClassId: nextClassId,
                nextSubjectId: nextSubjectId,
                version: '1.0',
                savedDate: new Date().toISOString()
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `rozklad_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ –†–æ–∑–∫–ª–∞–¥ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ—Ä—Å—ñ—ó
                    if (!data.version) {
                        alert('‚ö†Ô∏è –§–∞–π–ª –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤–µ—Ä—Å—ñ—é. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ.');
                    }
                    
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
                    classes = data.classes || [];
                    subjects = data.subjects || [];
                    schedules = data.schedules || {};
                    nextClassId = data.nextClassId || 1;
                    nextSubjectId = data.nextSubjectId || 1;
                    
                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
                    renderClasses();
                    renderSubjects();
                    renderSchedules();
                    
                    const savedDate = data.savedDate ? new Date(data.savedDate).toLocaleString('uk-UA') : '–Ω–µ–≤—ñ–¥–æ–º–∞';
                    alert(`‚úÖ –†–æ–∑–∫–ª–∞–¥ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!\n–î–∞—Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${savedDate}`);
                } catch (error) {
                    alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª –Ω–µ –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏–π.');
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
                }
            };
            reader.readAsText(file);
            
            // –û—á–∏—â–∞—î–º–æ input –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–æ–π —Å–∞–º–∏–π —Ñ–∞–π–ª –∑–Ω–æ–≤—É
            event.target.value = '';
        }

        // –§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –≤ Excel
        function checkTeacherConflicts() {
            const conflicts = [];
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–µ–Ω –¥–µ–Ω—å —Ç–∞ —É—Ä–æ–∫
            days.forEach((day, dayIndex) => {
                for (let lessonNum = 0; lessonNum < lessons; lessonNum++) {
                    const key = `${dayIndex}-${lessonNum}`;
                    const teachersInThisSlot = {};
                    
                    // –ó–±–∏—Ä–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—á–∏—Ç–µ–ª—ñ–≤ –≤ —Ü—å–æ–º—É —Å–ª–æ—Ç—ñ
                    classes.forEach(cls => {
                        const lesson = schedules[cls.id][key];
                        
                        if (lesson) {
                            // –û–±—Ä–æ–±–ª—è—î–º–æ —è–∫ –æ–¥–∏–Ω–æ—á–Ω–∏–π —É—Ä–æ–∫, —Ç–∞–∫ —ñ –º–∞—Å–∏–≤
                            const lessons = Array.isArray(lesson) ? lesson : [lesson];
                            
                            lessons.forEach(les => {
                                if (!teachersInThisSlot[les.teacher]) {
                                    teachersInThisSlot[les.teacher] = [];
                                }
                                teachersInThisSlot[les.teacher].push({
                                    className: cls.name,
                                    subjectName: les.name
                                });
                            });
                        }
                    });
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –≤—á–∏—Ç–µ–ª—ñ —è–∫—ñ –≤–µ–¥—É—Ç—å —É—Ä–æ–∫ —É –±—ñ–ª—å—à –Ω—ñ–∂ –æ–¥–Ω–æ–º—É –∫–ª–∞—Å—ñ
                    Object.keys(teachersInThisSlot).forEach(teacher => {
                        if (teachersInThisSlot[teacher].length > 1) {
                            conflicts.push({
                                day: day,
                                lesson: lessonNum + 1,
                                teacher: teacher,
                                classes: teachersInThisSlot[teacher]
                            });
                        }
                    });
                }
            });
            
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
            if (conflicts.length === 0) {
                alert('‚úÖ –ó–±—ñ–≥—ñ–≤ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ! –†–æ–∑–∫–ª–∞–¥ —Å–∫–ª–∞–¥–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.');
            } else {
                let message = '‚ö†Ô∏è –í–∏—è–≤–ª–µ–Ω–æ –∑–±—ñ–≥–∏:\n\n';
                conflicts.forEach(conflict => {
                    message += `${conflict.day}, –£—Ä–æ–∫ ${conflict.lesson}\n`;
                    message += `–í—á–∏—Ç–µ–ª—å: ${conflict.teacher}\n`;
                    message += `–ö–ª–∞—Å–∏: ${conflict.classes.map(c => `${c.className} (${c.subjectName})`).join(', ')}\n\n`;
                });
                alert(message);
            }
        }

        function exportToExcel() {
            if (classes.length === 0 || subjects.length === 0) {
                alert('‚ö†Ô∏è –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –î–æ–¥–∞–π—Ç–µ –∫–ª–∞—Å–∏ —Ç–∞ –ø—Ä–µ–¥–º–µ—Ç–∏.');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ SheetJS
            if (typeof XLSX === 'undefined') {
                alert('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ Excel... –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
                return;
            }

            try {
                // –°—Ç–≤–æ—Ä—é—î–º–æ workbook
                const wb = XLSX.utils.book_new();

                // –°—Ç–≤–æ—Ä—é—î–º–æ –≥–æ–ª–æ–≤–Ω—É —Ç–∞–±–ª–∏—Ü—é - —Ç–æ—á–Ω–∞ –∫–æ–ø—ñ—è —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–∑–∫–ª–∞–¥—É
                const data = [];
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                const headerRow = ['–î–µ–Ω—å', '–£—Ä–æ–∫'];
                classes.forEach(cls => headerRow.push(cls.name));
                data.push(headerRow);

                // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –¥–∞–Ω—ñ –ø–æ –¥–Ω—è—Ö —Ç–∞ —É—Ä–æ–∫–∞–º
                days.forEach((day, dayIndex) => {
                    for (let i = 1; i <= lessons; i++) {
                        const row = [];
                        
                        // –î–æ–¥–∞—î–º–æ –¥–µ–Ω—å —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–µ—Ä—à–æ–≥–æ —É—Ä–æ–∫—É
                        if (i === 1) {
                            row.push(day);
                        } else {
                            row.push(''); // –ü–æ—Ä–æ–∂–Ω—è –∫–ª—ñ—Ç–∏–Ω–∫–∞ –¥–ª—è –æ–±'—î–¥–Ω–∞–Ω–Ω—è
                        }
                        
                        // –ù–æ–º–µ—Ä —É—Ä–æ–∫—É
                        row.push(i);
                        
                        // –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–ª–∞—Å—É
                        classes.forEach(cls => {
                            const key = `${dayIndex}-${i-1}`;
                            const lesson = schedules[cls.id][key];
                            
                            if (lesson) {
                                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –º–∞—Å–∏–≤ —É—Ä–æ–∫—ñ–≤ (–ø—ñ–¥–≥—Ä—É–ø–∏)
                                if (Array.isArray(lesson)) {
                                    // –û–±'—î–¥–Ω—É—î–º–æ –≤—Å—ñ —É—Ä–æ–∫–∏ –≤ –æ–¥–Ω—É –∫–ª—ñ—Ç–∏–Ω–∫—É
                                    const lessonsText = lesson.map(l => `${l.name}\n(${l.teacher})`).join('\n---\n');
                                    row.push(lessonsText);
                                } else {
                                    // –û–¥–∏–Ω —É—Ä–æ–∫
                                    row.push(`${lesson.name}\n(${lesson.teacher})`);
                                }
                            } else {
                                row.push('');
                            }
                        });
                        
                        data.push(row);
                    }
                });

                // –°—Ç–≤–æ—Ä—é—î–º–æ worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
                const colWidths = [
                    { wch: 12 },  // –î–µ–Ω—å
                    { wch: 8 }    // –£—Ä–æ–∫
                ];
                classes.forEach(() => colWidths.push({ wch: 25 })); // –ö–ª–∞—Å–∏
                ws['!cols'] = colWidths;

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∏—Å–æ—Ç—É —Ä—è–¥–∫—ñ–≤
                ws['!rows'] = [];
                for (let i = 0; i < data.length; i++) {
                    ws['!rows'].push({ hpt: i === 0 ? 20 : 50 }); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—à–∏–π, —Ä–µ—à—Ç–∞ –±—ñ–ª—å—à—ñ
                }

                // –û–±'—î–¥–Ω—É—î–º–æ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –¥–ª—è –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è
                if (!ws['!merges']) ws['!merges'] = [];
                
                let currentRow = 1; // –ü–æ—á–∏–Ω–∞—î–º–æ –∑ 1 (0 - –∑–∞–≥–æ–ª–æ–≤–æ–∫)
                days.forEach(() => {
                    // –û–±'—î–¥–Ω—É—î–º–æ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –¥–Ω—è (lessons —Ä—è–¥–∫—ñ–≤)
                    ws['!merges'].push({
                        s: { r: currentRow, c: 0 },
                        e: { r: currentRow + lessons - 1, c: 0 }
                    });
                    currentRow += lessons;
                });

                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Å—Ç–∏–ª—ñ –¥–æ –≤—Å—ñ—Ö –∫–ª—ñ—Ç–∏–Ω–æ–∫
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = { c: C, r: R };
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (!ws[cell_ref]) {
                            ws[cell_ref] = { t: 's', v: '' };
                        }
                        
                        // –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –≤—Å—ñ—Ö –∫–ª—ñ—Ç–∏–Ω–æ–∫
                        ws[cell_ref].s = {
                            alignment: {
                                horizontal: 'center',
                                vertical: 'middle',
                                wrapText: true
                            },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                        
                        // –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
                        if (R === 0) {
                            ws[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: '667eea' }
                            };
                            ws[cell_ref].s.font = {
                                bold: true,
                                color: { rgb: 'FFFFFF' },
                                sz: 12
                            };
                        }
                        // –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–î–µ–Ω—å"
                        else if (C === 0) {
                            ws[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: 'e9ecef' }
                            };
                            ws[cell_ref].s.font = {
                                bold: true,
                                sz: 11
                            };
                        }
                        // –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–£—Ä–æ–∫"
                        else if (C === 1) {
                            ws[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: 'f8f9fa' }
                            };
                            ws[cell_ref].s.font = {
                                bold: true,
                                sz: 11
                            };
                        }
                    }
                }

                // –î–æ–¥–∞—î–º–æ worksheet –¥–æ workbook
                XLSX.utils.book_append_sheet(wb, ws, '–†–æ–∑–∫–ª–∞–¥');

                // –°—Ç–≤–æ—Ä—é—î–º–æ –∞—Ä–∫—É—à –∑—ñ —Å–ø–∏—Å–∫–æ–º –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                const subjectsData = [['–ü—Ä–µ–¥–º–µ—Ç', '–í—á–∏—Ç–µ–ª—å', '–ì–æ–¥–∏–Ω/—Ç–∏–∂–¥–µ–Ω—å', '–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ']];
                subjects.forEach(subject => {
                    let usedCount = 0;
                    classes.forEach(cls => {
                        const schedule = schedules[cls.id] || {};
                        Object.values(schedule).forEach(slot => {
                            if (Array.isArray(slot)) {
                                usedCount += slot.filter(s => s.subjectId === subject.id).length;
                            } else if (slot && slot.subjectId === subject.id) {
                                usedCount++;
                            }
                        });
                    });
                    subjectsData.push([subject.name, subject.teacher, subject.hours, usedCount]);
                });

                const subjectsWs = XLSX.utils.aoa_to_sheet(subjectsData);
                subjectsWs['!cols'] = [{ wch: 25 }, { wch: 25 }, { wch: 15 }, { wch: 15 }];
                
                // –°—Ç–∏–ª—ñ –¥–ª—è –∞—Ä–∫—É—à—É –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                const subjectsRange = XLSX.utils.decode_range(subjectsWs['!ref']);
                for (let R = subjectsRange.s.r; R <= subjectsRange.e.r; ++R) {
                    for (let C = subjectsRange.s.c; C <= subjectsRange.e.c; ++C) {
                        const cell_address = { c: C, r: R };
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (!subjectsWs[cell_ref]) continue;
                        
                        subjectsWs[cell_ref].s = {
                            alignment: {
                                horizontal: 'center',
                                vertical: 'middle'
                            },
                            border: {
                                top: { style: 'thin' },
                                bottom: { style: 'thin' },
                                left: { style: 'thin' },
                                right: { style: 'thin' }
                            }
                        };
                        
                        if (R === 0) {
                            subjectsWs[cell_ref].s.fill = {
                                patternType: 'solid',
                                fgColor: { rgb: '667eea' }
                            };
                            subjectsWs[cell_ref].s.font = {
                                bold: true,
                                color: { rgb: 'FFFFFF' }
                            };
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, subjectsWs, '–ü—Ä–µ–¥–º–µ—Ç–∏');

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
                const fileName = `rozklad_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert('‚úÖ –†–æ–∑–∫–ª–∞–¥ —É—Å–ø—ñ—à–Ω–æ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ –≤ Excel!');
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç—ñ –≤ Excel: ' + error.message);
                console.error('–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É:', error);
            }
        }

        renderClasses();
        renderSubjects();
        renderSchedules();
    </script>
</body>
</html>
